{% extends 'base.html' %}

{% block content %}
  <main class="pt-5 m-5">
    <div class="row mt-5 justify-content-center">
      <div style="max-width: 40rem;">
        <form class="card card-body" method="POST" enctype="multipart/form-data" style="background-color: rgb(255, 255, 255, 0.8);">
          <h1 class="mb-4">Detalle de la solicitud</h1>

          {{ error }}

          {% csrf_token %}

          <div style="display: none;">
            {{ solicitud_form.es_migracion.label_tag }}
            {{ solicitud_form.es_migracion }}
            <p id="error-es-migracion" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
          </div>

          {% if solicitud.es_migracion %}

            <!-- Material migración fields -->
            <h2 style="margin-bottom: 2rem;">Migración - {{ solicitud.nombre_producto_migracion }}</h2>

            <div id="material-migracion-empresas" style="display: flex; gap: 1rem;">
              <!-- Empresa origen -->
              <div style="width: 100%;">
                <p class="m-0">{{ solicitud_form.empresa_origen.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                {{ solicitud_form.empresa_origen }}
                <p id="error-empresa-origen" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
              </div>

              <!-- Empresa destino -->
              <div style="width: 100%;">
                <p class="m-0">{{ solicitud_form.empresa_destino.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                {{ solicitud_form.empresa_destino }}
                <p id="error-empresa-destino" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
              </div>
            </div>

            <p id="error-empresas-migracion" class="mt-0 mb-2" style="color:red; display:none;">Empresa origen y Empresa destino deben tener valores distintos</p>

            <!-- Nombre producto migracion field -->
            <div class="mt-3 mb-3">
              <label for="id_nombre_producto_migracion">Nombre:<span style="color: rgb(192, 0, 0);">*</span></label>
              {{ solicitud_form.nombre_producto_migracion }}
              <datalist id="opciones_material">
              </datalist>
              <p id="error-nombre-producto-migracion" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Ingrese un nombre de producto válido</p>
              <p id="error-nombre-producto-migracion-2" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">No existe ningún producto con ese nombre</p>
            </div>

          {% else %}

            <!-- Material nuevo fields -->
            <!-- Empresa field -->
            <div style="margin-bottom:1rem;">
              <p class="m-0">{{ solicitud_form.empresa.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
              {{ solicitud_form.empresa }}
              <p id="error-empresa" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
            </div>

            <!-- Justificación field -->
            <div style="margin-bottom:1rem;">
              <label for="id_justificacion">Justificación:<span style="color: rgb(192, 0, 0);">*</span></label>
              {{ solicitud_form.justificacion }}
              <p id="error-justificacion" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es requerido</p>
            </div>

            <div id="title-button-container" class="d-flex justify-content-between">
              <h3>Materiales / servicios</h3>
              {% if current_user.sistemas %}
                <button id="id_btn_download_table" class="btn btn-secondary btn-download-table" type="button" style="font-size: 0.8rem; color: white;">
                  ↓
                </button>
              {% endif %}
            </div>

            <div id="table-materials" class="table-responsive my-3" style="font-size: 0.8rem; background-color: rgb(255, 255, 255);">
              <table id="materials-table" class="table table-bordered table-sm">
                <thead class="text-center">
                  <tr>
                    {% if current_user.sistemas and solicitud.finanzas or solicitud.sistemas %}
                      <th scope="col" style="min-width: 6rem;">Código</th>
                    {% endif %}
                    <th scope="col" style="min-width: 6rem;">Tipo alta</th>
                    <th scope="col" style="min-width: 6rem;">Subfamilia</th>
                    <th scope="col" style="min-width: 6rem;">Nombre</th>
                    <th scope="col" style="min-width: 6rem;">Foto</th>
                    <th scope="col" style="min-width: 6rem;">Ficha técnica</th>
                    <th scope="col" style="min-width: 6rem;">Largo</th>
                    <th scope="col" style="min-width: 6rem;">Ancho / Calibre</th>
                    <th scope="col" style="min-width: 6rem;">Alto</th>
                    <th scope="col" style="min-width: 6rem;">Material</th>
                    <th scope="col" style="min-width: 6rem;">Color</th>
                    <th scope="col" style="min-width: 6rem;">Marca</th>
                    <th scope="col" style="min-width: 6rem;">Parte / Modelo</th>
                    <th scope="col" style="min-width: 6rem;">Nombre común</th>
                    <th scope="col" style="min-width: 6rem;">Ing. activo</th>
                    <th scope="col" style="min-width: 6rem;">Porcentaje IVA</th>
                    <th scope="col" style="min-width: 6rem;">Alias</th>
                    <th scope="col" style="min-width: 6rem;">Unidad de medida</th>
                    <th scope="col" style="min-width: 6rem;">Código SAT</th>
                    <th scope="col" style="min-width: 6rem;">¿Es mezcla?</th>
                    <th scope="col" style="min-width: 6rem;">¿Es material empaque?</th>
                    <th scope="col" style="min-width: 6rem;">¿Es prod. terminado?</th>
                    <th scope="col" style="min-width: 4rem;"></th>
                    <th scope="col" style="min-width: 4rem;"></th>
                  </tr>
                </thead>
                <tbody id="tbody-materials"></tbody>
              </table>
            </div>

            {{ material_formset.management_form }}
            <div id="material-forms">
              {% for form in material_forms %}
                <div id="material-form-{{ forloop.counter0 }}" class="material-form" style="display:none;">
                  
                  <div style="display: flex; gap: 1rem; margin-bottom:1rem;">
                    <!-- Tipo alta field -->
                    <div class="tipo-alta-container" style="width: 100%;">
                      <p class="m-0">{{ form.tipo_alta.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                      {{ form.tipo_alta }}
                      <p id="error-tipo-alta" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                    </div>

                    <!-- Código field -->
                    {% if current_user.sistemas and solicitud.finanzas or solicitud.sistemas %}
                      <div class="codigo-container" style="width: 100%;">
                        <p class="m-0">Código<span style="color: rgb(192, 0, 0);">*</span></p>
                        {{ form.codigo }}
                        <p id="error-codigo" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">El código debe tener al menos 8 caracteres</p>
                      </div>
                    {% endif %}
                  </div>

                  <!-- Subfamilia field -->
                  <div class="subfamilia-container" style="margin-bottom:1rem;">
                    <p class="m-0">{{ form.subfamilia.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                    {{ form.subfamilia }}
                    <p id="error-subfamilia" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                  </div>

                  <!-- Nombre producto field -->
                  <div class="nombre-producto-container" style="margin-bottom:1rem;">
                    <label for="id_nombre_producto">Nombre:<span style="color: rgb(192, 0, 0);">*</span></label>
                    {{ form.nombre_producto }}
                    <datalist id="opciones_material">
                    </datalist>
                    <p id="error-nombre-producto" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    <p id="error-nombre-producto-2" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Ya existe un producto con ese nombre</p>
                  </div>

                  <!-- Documentos -->
                  <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">

                    <!-- Foto producto field -->
                    <div class="foto-producto-container d-flex" style="width: 50%; flex-direction: column; align-items: center; justify-content: flex-end;">

                      {% if form.foto_producto.value %}
                        <div id="image_preview_container" style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                      {% else %}
                        <div id="image_preview_container" style="display: flex; flex-direction: column; align-items: center; justify-content: center; display: none;">
                      {% endif %}
                        <div style="display: flex; align-items: flex-end; gap: 0.5rem;">
                          <!-- Preview de la foto -->
                          <img id="id_foto_producto_img" class="mb-2 rounded" src="/{{ form.foto_producto.value }}" alt="Foto" style="max-width: 80%; max-height: 10rem;" />
                          
                          <!-- Botón para eliminar la foto -->
                          <button id="id_btn_delete_foto_producto" class="btn btn-secondary btn-delete-foto-producto mb-2" type="button" style="background-color: #B22222; color: white; font-size: 0.8rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/> </svg>
                          </button>
                        </div>

                        <!-- Enlace para descargar la foto -->
                        <a id="id_foto_producto_download" href="/{{ form.foto_producto.value }}" class="mb-2" style="width:fit-content; display: block;" download="">Descargar foto</a>
                      </div>

                      <label for="id_foto_producto" class="mb-2" style="display: block;"><span id="foto-producto-label">Foto: <span style="font-size: 0.8rem; font-style: italic;">(solo imágenes)</span></span></label>
                      {{ form.foto_producto }}
                      <p id="error-foto-producto" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                    </div>
  
                    <!-- Ficha técnica field -->
                    <div class="ficha-tecnica-container d-flex" style="width: 50%; flex-direction: column; align-items: center; justify-content: flex-end;">

                      {% if form.ficha_tecnica.value %}
                        <div id="image_preview_container" style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                      {% else %}
                        <div id="image_preview_container" style="display: flex; flex-direction: column; align-items: center; justify-content: center; display: none;">
                      {% endif %}
                        <div style="display: flex; align-items: flex-end; gap: 0.5rem;">
                          <!-- Preview de la ficha técnica -->
                          <img id="id_ficha_tecnica_img" class="mb-2 rounded" src="/{{ form.ficha_tecnica.value }}" alt="Ficha técnica" style="max-width: 80%; max-height: 10rem;" />
                          
                          <!-- Botón para eliminar la ficha técnica -->
                          <button id="id_btn_delete_ficha_tecnica" class="btn btn-secondary btn-delete-ficha-tecnica mb-2" type="button" style="background-color: #B22222; color: white; font-size: 0.8rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/> </svg>
                          </button>
                        </div>

                        <!-- Enlace para descargar la ficha técnica -->
                        <a id="id_ficha_tecnica_download" href="/{{ form.ficha_tecnica.value }}" class="mb-2" style="width:fit-content; display: block;" download="">Descargar ficha técnica</a>
                      </div>

                      <label for="id_ficha_tecnica" class="mb-2" style="display: block;"><span id="ficha-tecnica-label">Ficha técnica:</span></label>
                      {{ form.ficha_tecnica }}
                      <p id="error-ficha-tecnica" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                    </div>
                  </div>

                  <div id="medidas-container">
                    <p class="m-0">Medidas <span style="font-size: 0.8rem; font-style: italic;">(El valor debe ser numérico, fracción o N/A)</span></p>
                    
                    <div style="display: flex; gap: 1rem;">
                      <!-- Largo field -->
                      <div class="largo-container" style="width: 33%; margin-bottom:1rem;">
                        <p class="m-0">{{ form.largo.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                        {{ form.largo }}
                        <p id="error-largo" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">El valor debe ser numérico, fracción o N/A</p>
                        {% if form.largo.value == 'N/A' %}
                          <p id="label-largo" style="margin-bottom:0; margin-left: 0.2rem; font-size: 0.8rem; font-style: italic; color: 'gray';">No aplica</p>
                        {% else %}
                          <p id="label-largo" style="margin-bottom:0; margin-left: 0.2rem; font-size: 0.8rem; font-style: italic; color: 'gray';">{{ form.um_largo.value }}</p>
                        {% endif %}
                      </div>
  
                      <!-- Ancho field -->
                      <div class="ancho-container" style="width: 33%; margin-bottom:1rem;">
                        <p class="m-0">Ancho / Calibre<span style="color: rgb(192, 0, 0);">*</span></p>
                        {{ form.ancho }}
                        <p id="error-ancho" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">El valor debe ser numérico, fracción o N/A</p>
                        {% if form.ancho.value == 'N/A' %}
                          <p id="label-ancho" style="margin-bottom:0; margin-left: 0.2rem; font-size: 0.8rem; font-style: italic; color: 'gray';">No aplica</p>
                        {% else %}
                          <p id="label-ancho" style="margin-bottom:0; margin-left: 0.2rem; font-size: 0.8rem; font-style: italic; color: 'gray';">{{ form.um_ancho.value }}</p>
                        {% endif %}
                      </div>
  
                      <!-- Alto field -->
                      <div class="alto-container" style="width: 33%; margin-bottom:1rem;">
                        <p class="m-0">{{ form.alto.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                        {{ form.alto }}
                        <p id="error-alto" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">El valor debe ser numérico, fracción o N/A</p>
                        {% if form.alto.value == 'N/A' %}
                          <p id="label-alto" style="margin-bottom:0; margin-left: 0.2rem; font-size: 0.8rem; font-style: italic; color: 'gray';">No aplica</p>
                        {% else %}
                          <p id="label-alto" style="margin-bottom:0; margin-left: 0.2rem; font-size: 0.8rem; font-style: italic; color: 'gray';">{{ form.um_alto.value }}</p>
                        {% endif %}
                      </div>
                    </div>

                    <div id="id-unidades-medida" class="d-flex justify-content-between gap-3">
                      <div>
                        <label for="id-medidas-iguales">Todas las medidas tienen la misma unidad:</label>
                        <input type="checkbox" id="id-medidas-iguales" class="medidas-iguales">
                      </div>
  
                      <div class="mb-1" style="width: 12rem;">
                        <!-- UM Largo field -->
                        <div id="select-largo">
                          {{ form.um_largo }}
                          <p id="error-largo" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                        </div>
                        <!-- UM Ancho field -->
                        <div id="select-ancho" style="display: none;">
                          {{ form.um_ancho }}
                          <p id="error-ancho" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                        </div>
                        <!-- UM Alto field -->
                        <div id="select-alto" style="display: none;">
                          {{ form.um_alto }}
                          <p id="error-alto" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                        </div>

                        <p id="error-unidades-medida" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una unidad para cada medida</p>
                      </div>
                    </div>
                  </div>

                  <div id="material-color-container" style="display: flex; gap: 1rem;">
                    <!-- Material field -->
                    <div class="material-container" style="width: 50%; margin-bottom:1rem;">
                      <p class="m-0">{{ form.material.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                      {{ form.material }}
                      <p id="error-material" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>

                    <!-- Color field -->
                    <div class="color-container" style="width: 50%; margin-bottom:1rem;">
                      <p class="m-0">{{ form.color.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                      {{ form.color }}
                      <p id="error-color" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>
                  </div>

                  <div style="display: flex; gap: 1rem;">
                    <!-- Marca field -->
                    <div style="width: 50%; margin-bottom:1rem;">
                      {{ form.marca.label_tag }}
                      {{ form.marca }}
                      <p id="error-marca" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>

                    <!-- Parte / Modelo field -->
                    <div style="width: 50%; margin-bottom:1rem;">
                      <label for="id_parte_modelo">Parte / Modelo:</label>
                      {{ form.parte_modelo }}
                      <p id="error-parte-modelo" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>
                  </div>

                  <div style="display: flex; gap: 1rem;">
                    <!-- Nombre común field -->
                    <div style="width: 50%; margin-bottom:1rem;">
                      <label for="id_nombre_comun">Nombre común:</label>
                      {{ form.nombre_comun }}
                      <p id="error-nombre-comun" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>

                    <!-- Ing activo field -->
                    <div style="width: 50%; margin-bottom:1rem;">
                      <label for="id_ing_activo">Ingrediente activo:</label>
                      {{ form.ing_activo }}
                      <p id="error-ing-activo" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>
                  </div>

                  <div style="display: flex; gap: 1rem;">
                    <!-- Porcentaje IVA field -->
                    <div class="porcentaje-iva-container" style="width: 50%; margin-bottom:1rem;">
                      <label for="id_porcentaje_iva">% de IVA:</label>
                      {{ form.porcentaje_iva }}
                      <p id="error-porcentaje-iva" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>

                    <!-- Alias field -->
                    <div style="width: 50%; margin-bottom:1rem;">
                      {{ form.alias.label_tag }}
                      {{ form.alias }}
                      <p id="error-alias" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>
                  </div>

                  <div style="display: flex; gap: 1rem;">
                    <!-- Unidad de medida field -->
                    <div class="unidad-medida-container" style="width: 50%; margin-bottom:1rem;">
                      <label for="id_unidad_medida">Unidad de medida:<span style="color: rgb(192, 0, 0);">*</span></label>
                      {{ form.unidad_medida }}
                      <p id="error-unidad-medida" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                    </div>

                    <!-- Código sat field -->
                    <div style="width: 50%; margin-bottom:1rem;">
                      <label for="id_codigo_sat">Código SAT:</label>
                      {{ form.codigo_sat }}
                      <p id="error-codigo-sat" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>
                  </div>

                  <div style="display: flex; justify-content: space-between; gap: 2rem;">
                    <!-- Es mezcla field -->
                    <div style="margin-bottom:1rem;">
                      <label for="id_es_mezcla">¿Es mezcla?</label>
                      {{ form.es_mezcla }}
                      <p id="error-es-mezcla" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>

                    <!-- Es material empaque field -->
                    <div style="margin-bottom:1rem;">
                      <label for="id_es_material_empaque">¿Es material empaque?</label>
                      {{ form.es_material_empaque }}
                      <p id="error-es-material-empaque" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>

                    <!-- Es prod terminado field -->
                    <div style="margin-bottom:1rem;">
                      <label for="id_es_prod_terminado">¿Es prod. terminado?</label>
                      {{ form.es_prod_terminado }}
                      <p id="error-es-prod-terminado" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>
                  </div>

                  <!-- Esta bandera será false. Si el material se elimina, entonces se marcará como true -->
                  {{ form.rechazado }}

                  {% if current_user.id == solicitud.usuario.id and solicitud.rechazado_compras or current_user.id == solicitud.usuario.id and solicitud.rechazado_sistemas or solicitud.pendiente and current_user.compras or solicitud.compras and current_user.finanzas or solicitud.finanzas and current_user.sistemas %}
                    <button class="btn btn-secondary mt-3 mb-3 btn-save-changes" type="button" style="width: 10rem; background-color: #008841; color: white; font-weight: bold;">Guardar cambios</button>
                  {% else %}
                    <button class="btn btn-secondary mt-3 mb-3 btn-save-changes" type="button" style="width: 10rem; background-color: #008841; color: white; font-weight: bold;">Cerrar</button>
                  {% endif %}
                </div>
              {% endfor %}

              <!-- Formset de materiales -->
              {% if solicitud.rechazado_compras or solicitud.rechazado_finanzas or solicitud.rechazado_sistemas %}
                {% for material_form in material_formset %}
                  <div id="material-form-0" class="material-form material-form-0">

                    <!-- Tipo alta field -->
                    <div class="tipo-alta-container" style="margin-bottom:1rem;">
                      <p class="m-0">{{ material_form.tipo_alta.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                      {{ material_form.tipo_alta }}
                      <p id="error-tipo-alta" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                    </div>

                    <!-- Subfamilia field -->
                    <div class="subfamilia-container" style="margin-bottom:1rem;">
                      <p class="m-0">{{ material_form.subfamilia.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                      {{ material_form.subfamilia }}
                      <p id="error-subfamilia" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                    </div>

                    <!-- Nombre producto field -->
                    <div class="nombre-producto-container" style="margin-bottom:1rem;">
                      <label for="id_nombre_producto">Nombre producto / servicio:<span style="color: rgb(192, 0, 0);">*</span></label>
                      {{ material_form.nombre_producto }}
                      <datalist id="opciones_material">
                      </datalist>
                      <p id="error-nombre-producto" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                      <p id="error-nombre-producto-2" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Ya existe un producto con ese nombre</p>
                    </div>
                    
                    <!-- Documentos -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">

                      <!-- Foto producto field -->
                      <div class="foto-producto-container d-flex" style="width: 50%; flex-direction: column; align-items: center; justify-content: flex-end;">

                        <div style="display: flex; align-items: flex-end; gap: 0.5rem;">
                          <!-- Preview de la foto del producto -->
                          <img id="id_foto_producto_img" class="mb-2 rounded" src="" alt="Foto del producto" style="max-width: 80%; max-height: 10rem; display: none;" />

                          <!-- Botón para eliminar la foto del producto -->
                          <button id="id_btn_delete_foto_producto" class="btn btn-secondary btn-delete-foto-producto mb-2" type="button" style="background-color: #B22222; color: white; font-size: 0.8rem; display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/> </svg>
                          </button>
                        </div>

                        <label for="id_foto_producto" class="mb-2" style="display: block;"><span id="foto-producto-label">Foto: <span style="font-size: 0.8rem; font-style: italic;">(solo imágenes)</span></span></label>
                        {{ material_form.foto_producto }}
                        <p id="error-foto-producto" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                      </div>
    
                      <!-- Ficha técnica field -->
                      <div class="ficha-tecnica-container d-flex" style="width: 50%; flex-direction: column; align-items: center; justify-content: flex-end;">
                        <div style="display: flex; align-items: flex-end; gap: 0.5rem;">
                          <!-- Preview de la ficha técnica -->
                          <img id="id_ficha_tecnica_img" class="mb-2 rounded" src="" alt="Ficha técnica" style="max-width: 80%; max-height: 10rem; display: none;" />
                          
                          <!-- Botón para eliminar la ficha técnica -->
                          <button id="id_btn_delete_ficha_tecnica" class="btn btn-secondary btn-delete-ficha-tecnica mb-2" type="button" style="background-color: #B22222; color: white; font-size: 0.8rem; display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/> </svg>
                          </button>
                        </div>

                        <label for="id_ficha_tecnica" class="mb-2" style="display: block;"><span id="ficha-tecnica-label">Ficha técnica:</span></label>
                        {{ material_form.ficha_tecnica }}
                        <p id="error-ficha-tecnica" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                      </div>

                    </div>

                    <div id="medidas-container">
                      <p class="m-0">Medidas <span style="font-size: 0.8rem; font-style: italic;">(El valor debe ser numérico, fracción o N/A)</span></p>
                      
                      <div style="display: flex; gap: 1rem;">
                        <!-- Largo field -->
                        <div class="largo-container" style="width: 33%; margin-bottom:1rem;">
                          <p class="m-0">{{ material_form.largo.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                          {{ material_form.largo }}
                          <p id="error-largo" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">El valor debe ser numérico, fracción o N/A</p>
                          <p id="label-largo" style="margin-bottom:0; margin-left: 0.2rem; font-size: 0.8rem; font-style: italic; color: 'gray'; display:none;"></p>
                        </div>
    
                        <!-- Ancho field -->
                        <div class="ancho-container" style="width: 33%; margin-bottom:1rem;">
                          <p class="m-0">Ancho / Calibre<span style="color: rgb(192, 0, 0);">*</span></p>
                          {{ material_form.ancho }}
                          <p id="error-ancho" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">El valor debe ser numérico, fracción o N/A</p>
                          <p id="label-ancho" style="margin-bottom:0; margin-left: 0.2rem; font-size: 0.8rem; font-style: italic; color: 'gray'; display:none;"></p>
                        </div>
    
                        <!-- Alto field -->
                        <div class="alto-container" style="width: 33%; margin-bottom:1rem;">
                          <p class="m-0">{{ material_form.alto.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                          {{ material_form.alto }}
                          <p id="error-alto" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">El valor debe ser numérico, fracción o N/A</p>
                          <p id="label-alto" style="margin-bottom:0; margin-left: 0.2rem; font-size: 0.8rem; font-style: italic; color: 'gray'; display:none;"></p>
                        </div>
                      </div>

                      <div id="id-unidades-medida" class="d-flex justify-content-between gap-3">
                        <div>
                          <label for="id-medidas-iguales">Todas las medidas tienen la misma unidad:</label>
                          <input type="checkbox" id="id-medidas-iguales" class="medidas-iguales">
                        </div>
    
                        <div class="mb-1" style="width: 12rem;">
                          <!-- UM Largo field -->
                          <div id="select-largo">
                            {{ material_form.um_largo }}
                            <p id="error-largo" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                          </div>
                          <!-- UM Ancho field -->
                          <div id="select-ancho" style="display: none;">
                            {{ material_form.um_ancho }}
                            <p id="error-ancho" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                          </div>
                          <!-- UM Alto field -->
                          <div id="select-alto" style="display: none;">
                            {{ material_form.um_alto }}
                            <p id="error-alto" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                          </div>

                          <p id="error-unidades-medida" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una unidad para cada medida</p>
                        </div>
                      </div>
                    </div>

                    <div id="material-color-container" style="display: flex; gap: 1rem;">
                      <!-- Material field -->
                      <div class="material-container" style="width: 50%; margin-bottom:1rem;">
                        <p class="m-0">{{ material_form.material.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                        {{ material_form.material }}
                        <p id="error-material" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                      </div>

                      <!-- Color field -->
                      <div class="color-container" style="width: 50%; margin-bottom:1rem;">
                        <p class="m-0">{{ material_form.color.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                        {{ material_form.color }}
                        <p id="error-color" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                      </div>
                    </div>

                    <div style="display: flex; gap: 1rem;">
                      <!-- Marca field -->
                      <div style="width: 50%; margin-bottom:1rem;">
                        {{ material_form.marca.label_tag }}
                        {{ material_form.marca }}
                        <p id="error-tipo-alta" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                      </div>

                      <!-- Parte/Modelo field -->
                      <div style="width: 50%; margin-bottom:1rem;">
                        <label for="id_parte_modelo">Parte / Modelo:</label>
                        {{ material_form.parte_modelo }}
                        <p id="error-tipo-alta" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                      </div>
                    </div>

                    <div style="display: flex; gap: 1rem;">
                      <!-- Nombre común field -->
                      <div style="width: 50%; margin-bottom:1rem;">
                        <label for="id_nombre_comun">Nombre común:</label>
                        {{ material_form.nombre_comun }}
                        <p id="error-tipo-alta" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                      </div>

                      <!-- Ing activo field -->
                      <div style="width: 50%; margin-bottom:1rem;">
                        <label for="id_ing_activo">Ingrediente activo:</label>
                        {{ material_form.ing_activo }}
                        <p id="error-tipo-alta" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                      </div>
                    </div>

                    <div style="display: flex; gap: 1rem;">
                      <!-- Porcentaje IVA field -->
                      <div class="porcentaje-iva-container" style="width: 50%; margin-bottom:1rem;">
                        <label for="id_porcentaje_iva">% de IVA:</label>
                        {{ material_form.porcentaje_iva }}
                        <p id="error-porcentaje-iva" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                      </div>

                      <!-- Alias field -->
                      <div style="width: 50%; margin-bottom:1rem;">
                        {{ material_form.alias.label_tag }}
                        {{ material_form.alias }}
                        <p id="error-tipo-alta" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                      </div>
                    </div>

                    <div style="display: flex; gap: 1rem;">
                      <!-- Unidad de medida field -->
                      <div class="unidad-medida-container" style="width: 50%; margin-bottom:1rem;">
                        <label for="id_unidad_medida">Unidad de medida:<span style="color: rgb(192, 0, 0);">*</span></label>
                        {{ material_form.unidad_medida }}
                        <p id="error-unidad-medida" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                      </div>

                      <!-- Código SAT field -->
                      <div style="width: 50%; margin-bottom:1rem;">
                        <label for="id_codigo_sat">Código SAT:</label>
                        {{ material_form.codigo_sat }}
                        <p id="error-codigo-sat" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                      </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; gap: 2rem;">
                      <!-- Es mezcla field -->
                      <div style="margin-bottom:1rem;">
                        <label for="id_es_mezcla">¿Es mezcla?</label>
                        {{ material_form.es_mezcla }}
                        <p id="error-tipo-alta" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                      </div>

                      <!-- Es material empaque field -->
                      <div style="margin-bottom:1rem;">
                        <label for="id_es_material_empaque">¿Es material empaque?</label>
                        {{ material_form.es_material_empaque }}
                        <p id="error-tipo-alta" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                      </div>

                      <!-- Es prod terminado field -->
                      <div style="margin-bottom:1rem;">
                        <label for="id_es_prod_terminado">¿Es prod. terminado?</label>
                        {{ material_form.es_prod_terminado }}
                        <p id="error-tipo-alta" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                      </div>
                    </div>

                    <button class="btn btn-secondary mt-3 mb-3 btn-save-changes" type="button" style="width: 10rem; background-color: #008841; color: white; font-weight: bold;">Guardar</button>
                  </div>
                {% endfor %}

                <!-- Botón para añadir más materiales a una solicitud rechazada -->
                {% if solicitud.rechazado_compras or solicitud.rechazado_finanzas or solicitud.rechazado_sistemas %}
                  <button id="add-material" class="btn btn-secondary mt-1 mb-3" type="button" style="background-color: #008841; color: white; font-weight: bold; display: none;">Agregar Material / servicio</button>
                {% endif %}
              {% endif %}
            </div>

          {% endif %}

          <!-- Comentarios field -->
          {% if solicitud.pendiente and current_user.compras or solicitud.compras and current_user.finanzas or solicitud.finanzas and current_user.sistemas or solicitud.comentarios != '' %}
            <div style="margin-bottom:1rem;">
              {{ solicitud_form.comentarios.label_tag }}
              {{ solicitud_form.comentarios }}
              <p id="error-comentarios" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es requerido</p>
            </div>
          {% endif %}

          <div id="buttons-container" class="d-flex justify-content-between gap-2">
            {% if current_user.id == solicitud.usuario.id and solicitud.rechazado_compras or solicitud.rechazado_finanzas or solicitud.rechazado_sistemas or solicitud.borrador %}

              {% if solicitud.es_migracion %}
                <button id="btn-save" class="btn w-100 btn-save btn-rechazado-false" style="margin-top: 0.5rem; background-color: #008841; color: white; font-weight: bold;" type="submit" name="finanzas" value="True">Enviar</button>
              {% else %}
                <button id="btn-save" class="btn w-100 btn-save btn-rechazado-false" style="margin-top: 0.5rem; background-color: #008841; color: white; font-weight: bold;" type="submit" name="pendiente" value="True">Enviar</button>
              {% endif %}

              <button id="btn-remove" class="btn btn-remove w-100" style="margin-top: 0.5rem; background-color: tomato; color: white; font-weight: bold;" type="submit" name="eliminado" value="True">Eliminar solicitud</button>

            {% else %}

              {% if solicitud.pendiente and current_user.compras and not solicitud.borrador %}
                <!--{{ solicitud_form.rechazado_compras }}-->
                <button id="btn-approve" class="btn btn-approve w-100" style="margin-top: 0.5rem; background-color: #008841; color: white; font-weight: bold;" type="submit" name="finanzas" value="True">Aprobar</button>
                <button id="btn-decline" class="btn btn-reject w-100" style="margin-top: 0.5rem; background-color: tomato; color: white; font-weight: bold;" type="submit" name="rechazado_compras" value="True">Rechazar</button>
              {% endif %}

              {% if solicitud.finanzas and current_user.sistemas and not solicitud.borrador %}
                <!--{{ solicitud_form.rechazado_sistemas }}-->
                <button id="btn-approve" class="btn btn-approve w-100" style="margin-top: 0.5rem; background-color: #008841; color: white; font-weight: bold;" type="submit" name="sistemas" value="True">Guardar</button>
                <button id="btn-decline" class="btn btn-reject w-100" style="margin-top: 0.5rem; background-color: tomato; color: white; font-weight: bold;" type="submit" name="rechazado_sistemas" value="True">Rechazar</button>
              {% endif %}

            {% endif %}
          </div>
        </form>

        <button id="btn-back" class="btn btn-secondary mb-4">Volver</button>
      </div>
    </div>
  </main>

  <style>
      #id_btn_download_table {
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      #id_btn_download_table.visible {
        opacity: 1;
      }
      .table-row-hidden {
          display: none;
      }
      #btn-back {
          width: 10rem;
          margin-top: 2rem;
          font-weight: bold;
          background-color: rgb(0, 128, 0, 0.6);
          transition: 0.2s ease-in-out;
      }
      #btn-back:hover {
          scale: 1.05;
          background-color: rgb(0, 128, 0);
      }
      .material-foto-producto,
      .material-ficha-tecnica {
        width: 100%;
      }
  </style>

  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Containers
      const materialFormsContainer = document.getElementById('material-forms')
      const tableMaterials = document.getElementById('table-materials')
      const bodyMaterials = document.getElementById('tbody-materials')
      const buttonsContainer = document.getElementById('buttons-container')
      const datalist = document.getElementById("opciones_material")

      // Inputs
      const empresaOrigen = document.getElementById('id_empresa_origen')
      const empresaDestino = document.getElementById('id_empresa_destino')
      const nombreProductoMigracion = document.getElementById('id_nombre_producto_migracion')
      const empresa = document.getElementById('id_empresa')
      const justificacion = document.getElementById('id_justificacion')
      const comentarios = document.getElementById('id_comentarios')
      //const rechazado_compras = document.getElementById('id_rechazado_compras')
      //const rechazado_sistemas = document.getElementById('id_rechazado_sistemas')
      
      // Error messages
      const errorEmpresaOrigen = document.getElementById('error-empresa-origen')
      const errorEmpresaDestino = document.getElementById('error-empresa-destino')
      const errorEmpresasMigracion = document.getElementById('error-empresas-migracion')
      const errorNombreProductoMigracion = document.getElementById('error-nombre-producto-migracion')
      const errorNombreProductoMigracion2 = document.getElementById('error-nombre-producto-migracion-2')
      const errorEmpresa = document.getElementById('error-empresa')
      const errorJustificacion = document.getElementById('error-justificacion')
      const errorComentarios = document.getElementById('error-comentarios')
      
      // Buttons
      const btnSave = document.getElementById('btn-save')
      const btnRemove = document.getElementById('btn-remove')
      const btnApprove = document.getElementById('btn-approve')
      const btnDecline = document.getElementById('btn-decline')
      const btnBack = document.getElementById('btn-back')
      const btnsRechazadoFalse = document.querySelectorAll('.btn-rechazado-false')
      const btnDownloadTable = document.querySelector('#id_btn_download_table')
      const btnAddMaterial = document.querySelector('#add-material')
      
      // Regular expressions
      const fraccionPattern = /^(\d+(\.\d+)?\/\d+(\.\d+)?)$/;

      // Counters and bands
      let formCount = {{ material_formset.total_form_count }}
      let materialCounter = 0
      let medidasIguales = false
      let materialEliminado = false

      // Catalogo de materiales existentes
      var catalogoMaterial = {{ catalogo_material|safe }}

      // Catálogos de subfamilia y unidad de medida
      var subfamiliasProductoList = {{ subfamilia_producto_list|safe }}
      var subfamiliasServicioList = {{ subfamilia_servicio_list|safe }}
      var unidadesMedidaList = {{ unidad_medida_list|safe }}

      var sistemas = JSON.parse("{{ solicitud.sistemas|yesno:'true,false' }}");
      if (sistemas) {
        var codigoInputs = document.querySelectorAll('.material-codigo')
        codigoInputs.forEach(input => {
            input.setAttribute('readonly', true)
        })
      }

      if (nombreProductoMigracion) {
        nombreProductoMigracion.setAttribute('list', 'opciones_material')
      }

      btnBack.addEventListener('click', () => {
        window.history.back()
      })

      // Eventos para btnDownloadTable
      if (btnDownloadTable) {
        // Se hace visible cuando el mouse entra
        btnDownloadTable.addEventListener('mouseover', () => {
          btnDownloadTable.classList.add('visible')
        })
        // Se hace invisible cuando el mouse sale
        btnDownloadTable.addEventListener('mouseout', () => {
          btnDownloadTable.classList.remove('visible')
        })
        // Generar Excel a partir de la tabla de productos
        btnDownloadTable.addEventListener('click', () => {
          var tableSelect = document.getElementById('materials-table');
          var ws = XLSX.utils.table_to_sheet(tableSelect);
      
          // Crear el libro y agregar la hoja de cálculo
          var wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Productos');
      
          // Guardar el libro como archivo Excel
          XLSX.writeFile(wb, 'Tabla productos.xlsx');
        });
      }

      if (btnsRechazadoFalse) {
        btnsRechazadoFalse.forEach(btnRechazadoFalse => {
          btnRechazadoFalse.addEventListener('click', () => {
            const rechazadoBands = document.querySelectorAll('.material-rechazado')
            rechazadoBands.forEach(rechazadoBand => {
              rechazadoBand.value = false
            })
          })
        })
      }

      if (materialFormsContainer) {
        materialFormsContainer.addEventListener('click', event => {
          // Si se hace clic en "Guardar cambios", ocultar el formulario y actualizar la tabla
          if (event.target && event.target.classList.contains('btn-save-changes')) {
            const form = event.target.closest('.material-form')
            const tipoAlta = form.querySelector('.material-tipo-alta')
            const codigo = form.querySelector('.material-codigo')
            const subfamilia = form.querySelector('.material-subfamilia')
            const nombreProducto = form.querySelector('.material-nombre')
            const errorNombreProducto2 = form.querySelector('#error-nombre-producto-2')
            const largo = form.querySelector('.material-largo')
            const ancho = form.querySelector('.material-ancho')
            const alto = form.querySelector('.material-alto')
            const umLargo = form.querySelector('.select-um-largo')
            const umAncho = form.querySelector('.select-um-ancho')
            const umAlto = form.querySelector('.select-um-alto')
            const errorUnidadesMedida = form.querySelector('#error-unidades-medida')
            const material = form.querySelector('.material-material')
            const color = form.querySelector('.material-color')
            const porcentajeIva = form.querySelector('.material-porcentaje-iva')
            const unidadMedida = form.querySelector('.material-unidad-medida')

            // Errores
            const errorTipoAlta = form.querySelector('#error-tipo-alta')
            const errorCodigo = form.querySelector('#error-codigo')
            const errorSubfamilia = form.querySelector('#error-subfamilia')
            const errorNombreProducto = form.querySelector('#error-nombre-producto')
            const errorLargo = form.querySelector('#error-largo')
            const errorAncho = form.querySelector('#error-ancho')
            const errorAlto = form.querySelector('#error-alto')
            const errorMaterial = form.querySelector('#error-material')
            const errorColor = form.querySelector('#error-color')
            const errorPorcentajeIva = form.querySelector('#error-porcentaje-iva')
            const errorUnidadMedida = form.querySelector('#error-unidad-medida')

            // Si tipoAlta es 'Almacén', valida las medidas y sus unidades
            if (tipoAlta.value === 'Almacén') {
              if (largo.value != 'N/A' && umLargo.value == '') {
                errorUnidadesMedida.style.display = 'block'
                window.alert('Debe seleccionar una unidad para "Largo"')
                return
              }
              if (ancho.value != 'N/A' && umAncho.value == '') {
                errorUnidadesMedida.style.display = 'block'
                window.alert('Debe seleccionar una unidad para "Ancho"')
                return
              }
              if (alto.value != 'N/A' && umAlto.value == '') {
                errorUnidadesMedida.style.display = 'block'
                window.alert('Debe seleccionar una unidad para "Alto"')
                return
              }
            }
            // Si todas las medidas tienen una unidad, se oculta el error
            errorUnidadesMedida.style.display = 'none'
            if (largo.value == 'N/A') {
              umLargo.value = ''
            }
            if (ancho.value == 'N/A') {
              umAncho.value = ''
            }
            if (alto.value == 'N/A') {
              umAlto.value = ''
            }

            // Si tipoAlta es 'Servicio', no requiere largo, ancho, alto, material ni color
            if (tipoAlta.value === 'Servicio') {
              largo.value = ''
              umLargo.value = ''
              ancho.value = ''
              umAncho.value = ''
              alto.value = ''
              umAlto.value = ''
              material.value = ''
              color.value = ''
            }

            const mostrarErrores = () => {
              window.alert('Algún campo está vacío o es incorrecto')
              if (tipoAlta.value == '') {
                errorTipoAlta.style.display = 'block'
              }
              if (codigo && codigo.value.length < 8) {
                errorCodigo.style.display = 'block'
              }
              if (subfamilia.value == '') {
                errorSubfamilia.style.display = 'block'
              }
              if (nombreProducto.value == '') {
                errorNombreProducto.style.display = 'block'
              }
              if (largo.value == '') {
                errorLargo.style.display = 'block'
              }
              if (ancho.value == '') {
                errorAncho.style.display = 'block'
              }
              if (alto.value == '') {
                errorAlto.style.display = 'block'
              }
              if (material.value == '') {
                errorMaterial.style.display = 'block'
              }
              if (color.value == '') {
                errorColor.style.display = 'block'
              }
              if (porcentajeIva.value == '') {
                errorPorcentajeIva.style.display = 'block'
              }
              if (unidadMedida.value == '') {
                errorUnidadMedida.style.display = 'block'
              }
            }

            // Si el tipo de alta es '', devuelve un error
            if (tipoAlta.value == '') {
              mostrarErrores()
              return
            }

            if (codigo) {
              // Si el tipo de alta es 'Almacén', se requieren todos los campos obligatorios
              if (tipoAlta.value == 'Almacén' && (codigo.value.length < 8 || subfamilia.value == '' || nombreProducto.value == '' || errorNombreProducto2.style.display == 'block' || largo.value == '' || ancho.value == '' || alto.value == '' || errorUnidadesMedida.style.display == 'block' || material.value == '' || color.value == '' || porcentajeIva.value == '' || unidadMedida.value == '')) {
                mostrarErrores()
                return
              }
              // Si el tipo de alta es 'Servicio', no requiere largo, ancho, alto, material ni color
              if (tipoAlta.value == 'Servicio' && (codigo.value.length < 8 || subfamilia.value == '' || nombreProducto.value == '' || errorNombreProducto2.style.display == 'block' || porcentajeIva.value == '' || unidadMedida.value == '')) {
                mostrarErrores()
                return
              }
            }
            else {
              // Si el tipo de alta es 'Almacén', se requieren todos los campos obligatorios
              if (tipoAlta.value == 'Almacén' && (subfamilia.value == '' || nombreProducto.value == '' || errorNombreProducto2.style.display == 'block' || largo.value == '' || ancho.value == '' || alto.value == '' || errorUnidadesMedida.style.display == 'block' || material.value == '' || color.value == '' || porcentajeIva.value == '' || unidadMedida.value == '')) {
                mostrarErrores()
                return
              }
              // Si el tipo de alta es 'Servicio', no requiere largo, ancho, alto, material ni color
              if (tipoAlta.value == 'Servicio' && (subfamilia.value == '' || nombreProducto.value == '' || errorNombreProducto2.style.display == 'block' || porcentajeIva.value == '' || unidadMedida.value == '')) {
                mostrarErrores()
                return
              }
            }
            
            // Si todos los campos están correctos, oculta el formulario y actualiza la tabla
            const forms = materialFormsContainer.querySelectorAll('.material-form');
            forms.forEach(form => {
              form.style.display = 'none'
            })
            const editButtons = tableMaterials.querySelectorAll('.edit-material');
            editButtons.forEach(editButton => {
              editButton.removeAttribute('disabled')
            })
            fillTable()

            // Habilitar botones de tipo submit
            if (btnSave) {
              btnSave.removeAttribute('disabled')
              btnRemove.removeAttribute('disabled')
            }
            if (btnApprove) {
              btnApprove.removeAttribute('disabled')
              btnDecline.removeAttribute('disabled')
            }

            // Mostrar el botón para añadir material / servicio
            if (btnAddMaterial) {
              btnAddMaterial.style.display = 'block'
            }
          }
        })
      }
      
      // Aquí empieza el código nuevo
      if (btnAddMaterial) {
        btnAddMaterial.addEventListener('click', () => {
          // Ocultar el botón para añadir materiales
          btnAddMaterial.style.display = 'none'

          // Ocultando todos los formularios de material/servicio
          const materialForms = document.querySelectorAll('.material-form')
          materialForms.forEach(materialForm => {
            materialForm.style.display = 'none'
            formCount++
          })
          
          const formHtml = `
            <!-- Tipo alta field -->
            <div class="tipo-alta-container" style="margin-bottom:1rem;">
              <p class="m-0">{{ material_formset.empty_form.tipo_alta.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
              {{ material_formset.empty_form.tipo_alta }}
              <p id="error-tipo-alta" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
            </div>

            <!-- Subfamilia field -->
            <div class="subfamilia-container" style="margin-bottom:1rem;">
              <p class="m-0">{{ material_formset.empty_form.subfamilia.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
              {{ material_formset.empty_form.subfamilia }}
              <p id="error-subfamilia" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
            </div>

            <!-- Nombre producto field -->
            <div class="nombre-producto-container" style="margin-bottom:1rem;">
              <p class="m-0">{{ material_formset.empty_form.nombre_producto.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
              {{ material_formset.empty_form.nombre_producto }}
              <datalist id="opciones_material">
              </datalist>
              <p id="error-nombre-producto" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
              <p id="error-nombre-producto-2" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Ya existe un producto con ese nombre</p>
            </div>

            <!-- Documentos -->
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">

              <!-- Foto producto field -->
              <div class="foto-producto-container d-flex" style="width: 50%; flex-direction: column; align-items: center; justify-content: flex-end;">

                <div style="display: flex; align-items: flex-end; gap: 0.5rem;">

                  <!-- Preview de la foto del producto -->
                  <img id="id_foto_producto_img" class="mb-2 rounded" src="" alt="Foto del producto" style="max-width: 80%; max-height: 10rem; display: none;" />

                  <!-- Botón para eliminar la foto del producto -->
                  <button id="id_btn_delete_foto_producto" class="btn btn-secondary btn-delete-foto-producto mb-2" type="button" style="background-color: #B22222; color: white; font-size: 0.8rem; display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/> </svg>
                  </button>

                </div>

                <label for="id_foto_producto" class="mb-2" style="display: block;"><span id="foto-producto-label">Foto del producto: <span style="font-size: 0.8rem; font-style: italic;">(solo imágenes)</span></span></label>
                {{ material_formset.empty_form.foto_producto }}
                <p id="error-foto-producto" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
              </div>

              <!-- Ficha técnica field -->
              <div class="ficha-tecnica-container d-flex" style="width: 50%; flex-direction: column; align-items: center; justify-content: flex-end;">
                <div style="display: flex; align-items: flex-end; gap: 0.5rem;">

                  <!-- Preview de la ficha técnica -->
                  <img id="id_ficha_tecnica_img" class="mb-2 rounded" src="" alt="Ficha técnica" style="max-width: 80%; max-height: 10rem; display: none;" />
                  
                  <!-- Botón para eliminar la ficha técnica -->
                  <button id="id_btn_delete_ficha_tecnica" class="btn btn-secondary btn-delete-ficha-tecnica mb-2" type="button" style="background-color: #B22222; color: white; font-size: 0.8rem; display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/> </svg>
                  </button>
                </div>

                <label for="id_ficha_tecnica" class="mb-2" style="display: block;"><span id="ficha-tecnica-label">Ficha técnica:</span></label>
                {{ material_formset.empty_form.ficha_tecnica }}
                <p id="error-ficha-tecnica" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
              </div>

            </div>

            <div id="medidas-container">
              <p class="m-0">Medidas <span style="font-size: 0.8rem; font-style: italic;">(El valor debe ser numérico, fracción o N/A)</span></p>
              
              <div style="display: flex; gap: 1rem;">
                <!-- Largo field -->
                <div class="largo-container" style="width: 33%; margin-bottom:1rem;">
                  <p class="m-0">{{ material_formset.empty_form.largo.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                  {{ material_formset.empty_form.largo }}
                  <p id="error-largo" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">El valor debe ser numérico, fracción o N/A</p>
                  <p id="label-largo" style="margin-bottom:0; margin-left: 0.2rem; font-size: 0.8rem; font-style: italic; color: 'gray'; display:none;"></p>
                </div>

                <!-- Ancho field -->
                <div class="ancho-container" style="width: 33%; margin-bottom:1rem;">
                  <p class="m-0">{{ material_formset.empty_form.ancho.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                  {{ material_formset.empty_form.ancho }}
                  <p id="error-ancho" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">El valor debe ser numérico, fracción o N/A</p>
                  <p id="label-ancho" style="margin-bottom:0; margin-left: 0.2rem; font-size: 0.8rem; font-style: italic; color: 'gray'; display:none;"></p>
                </div>

                <!-- Alto field -->
                <div class="alto-container" style="width: 33%; margin-bottom:1rem;">
                  <p class="m-0">{{ material_formset.empty_form.alto.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                  {{ material_formset.empty_form.alto }}
                  <p id="error-alto" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">El valor debe ser numérico, fracción o N/A</p>
                  <p id="label-alto" style="margin-bottom:0; margin-left: 0.2rem; font-size: 0.8rem; font-style: italic; color: 'gray'; display:none;"></p>
                </div>
              </div>

              <div id="id-unidades-medida" class="d-flex justify-content-between gap-3">
                <div>
                  <label for="id-medidas-iguales">Todas las medidas tienen la misma unidad:</label>
                  <input type="checkbox" id="id-medidas-iguales" class="medidas-iguales">
                </div>

                <div class="mb-1" style="width: 12rem;">
                  <!-- UM Largo field -->
                  <div id="select-largo">
                    {{ material_formset.empty_form.um_largo }}
                    <p id="error-largo" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                  </div>
                  <!-- UM Ancho field -->
                  <div id="select-ancho" style="display: none;">
                    {{ material_formset.empty_form.um_ancho }}
                    <p id="error-ancho" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                  </div>
                  <!-- UM Alto field -->
                  <div id="select-alto" style="display: none;">
                    {{ material_formset.empty_form.um_alto }}
                    <p id="error-alto" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                  </div>

                  <p id="error-unidades-medida" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una unidad para cada medida</p>
                </div>
              </div>
            </div>

            <div id="material-color-container" style="display: flex; gap: 1rem;">
              <!-- Material field -->
              <div class="material-container" style="width: 50%; margin-bottom:1rem;">
                <p class="m-0">{{ material_formset.empty_form.material.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                {{ material_formset.empty_form.material }}
                <p id="error-material" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
              </div>

              <!-- Color field -->
              <div class="color-container" style="width: 50%; margin-bottom:1rem;">
                <p class="m-0">{{ material_formset.empty_form.color.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                {{ material_formset.empty_form.color }}
                <p id="error-color" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
              </div>
            </div>

            <div style="display: flex; gap: 1rem;">
              <!-- Marca field -->
              <div style="width: 50%; margin-bottom:1rem;">
                {{ material_formset.empty_form.marca.label_tag }}
                {{ material_formset.empty_form.marca }}
                <p id="error-tipo-alta" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
              </div>

              <!-- Parte/Modelo field -->
              <div style="width: 50%; margin-bottom:1rem;">
                <label for="id_parte_modelo">Parte / Modelo:</label>
                {{ material_formset.empty_form.parte_modelo }}
                <p id="error-tipo-alta" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
              </div>
            </div>

            <div style="display: flex; gap: 1rem;">
              <!-- Nombre común field -->
              <div style="width: 50%; margin-bottom:1rem;">
                <label for="id_nombre_comun">Nombre común:</label>
                {{ material_formset.empty_form.nombre_comun }}
                <p id="error-tipo-alta" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
              </div>

              <!-- Ing activo field -->
              <div style="width: 50%; margin-bottom:1rem;">
                <label for="id_ing_activo">Ingrediente activo:</label>
                {{ material_formset.empty_form.ing_activo }}
                <p id="error-tipo-alta" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
              </div>
            </div>

            <div style="display: flex; gap: 1rem;">
              <!-- Porcentaje IVA field -->
              <div class="porcentaje-iva-container" style="width: 50%; margin-bottom:1rem;">
                <label for="id_porcentaje_iva">% de IVA:</label>
                {{ material_formset.empty_form.porcentaje_iva }}
                <p id="error-porcentaje-iva" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
              </div>

              <!-- Alias field -->
              <div style="width: 50%; margin-bottom:1rem;">
                {{ material_formset.empty_form.alias.label_tag }}
                {{ material_formset.empty_form.alias }}
                <p id="error-tipo-alta" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
              </div>
            </div>

            <div style="display: flex; gap: 1rem;">
              <!-- Unidad de medida field -->
              <div class="unidad-medida-container" style="width: 50%; margin-bottom:1rem;">
                <label for="id_unidad_medida">Unidad de medida:<span style="color: rgb(192, 0, 0);">*</span></label>
                {{ material_formset.empty_form.unidad_medida }}
                <p id="error-unidad-medida" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
              </div>

              <!-- Código SAT field -->
              <div style="width: 50%; margin-bottom:1rem;">
                <label for="id_codigo_sat">Código SAT:</label>
                {{ material_formset.empty_form.codigo_sat }}
                <p id="error-codigo-sat" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 2rem;">
              <!-- Es mezcla field -->
              <div style="margin-bottom:1rem;">
                <label for="id_es_mezcla">¿Es mezcla?</label>
                {{ material_formset.empty_form.es_mezcla }}
                <p id="error-tipo-alta" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
              </div>

              <!-- Es material empaque field -->
              <div style="margin-bottom:1rem;">
                <label for="id_es_material_empaque">¿Es material empaque?</label>
                {{ material_formset.empty_form.es_material_empaque }}
                <p id="error-tipo-alta" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
              </div>

              <!-- Es prod terminado field -->
              <div style="margin-bottom:1rem;">
                <label for="id_es_prod_terminado">¿Es prod. terminado?</label>
                {{ material_formset.empty_form.es_prod_terminado }}
                <p id="error-tipo-alta" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
              </div>
            </div>

            <button class="btn btn-secondary mt-3 mb-3 btn-save-changes" type="button" style="width: 10rem; background-color: #008841; color: white; font-weight: bold;">Guardar</button>
          `;
          const form = document.createElement('div')
          form.id = `material-form-${formCount}`
          form.classList.add('material-form')
          form.classList.add(`material-form-${formCount}`)
          form.innerHTML = formHtml.replace(/__prefix__/g, formCount)
          materialFormsContainer.insertBefore(form, btnAddMaterial)

          document.querySelector("#id_material-TOTAL_FORMS").value = formCount;
          materialCounter++

          fillTable()
          validarCamposMaterial()
        });
      }
      // Aquí termina
      
      if (comentarios) {
        buttonsContainer.addEventListener('click', function(event) {  
          if (event.target && event.target.classList.contains('btn-save')) {
            comentarios.removeAttribute('required')
            comentarios.removeAttribute('readonly')
            comentarios.value = ''
          }
          if (event.target && event.target.classList.contains('btn-reject')) {
            comentarios.setAttribute('required', true)
            comentarios.removeAttribute('readonly')
            if(comentarios.value == '') {
              errorComentarios.style.display = 'block'
            }
          }
          if (event.target && event.target.classList.contains('btn-approve')) {
            if (!materialEliminado) {
              comentarios.removeAttribute('required')
              comentarios.value = ''
            }
            const forms = materialFormsContainer.querySelectorAll('.material-form');
            forms.forEach(form => {
              codigo = form.querySelector('.material-codigo')
              if (codigo && codigo.value.length < 8) {
                window.alert(`Debe añadir el código a "${form.querySelector('.material-nombre').value}"`)
                event.preventDefault()
              }
            })
          }
        });
      }

      const disableRemoveButtons = () => {
        const removeButtons = tableMaterials.getElementsByClassName('remove-material')
        if (btnApprove || btnDecline || btnSave || btnRemove) {
          if (materialCounter > 1) {
            for (i=0; i<removeButtons.length; i++) {
              removeButtons[i].removeAttribute('disabled')
            }
          }
          else {
            for (i=0; i<removeButtons.length; i++) {
              removeButtons[i].setAttribute('disabled', true)
            }
          }
        }
        else {
          for (i=0; i<removeButtons.length; i++) {
            removeButtons[i].setAttribute('disabled', true)
          }
        }
      }

      // FIELD VALIDATION

      const firstLetterCapitalized = str => {
        return str[0].toUpperCase() + str.slice(1).toLowerCase()
      }

      const firstLetterOfEachWordCapitalized = str => {
        return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
      }
      
      // Validación empresa origen
      if (empresaOrigen) {
        const validateEmpresaOrigen = () => {
          if (empresaOrigen.value == '') {
            errorEmpresaOrigen.style.display = 'block'
            errorEmpresasMigracion.style.display = 'none'
          } else {
            errorEmpresaOrigen.style.display = 'none'
            // No se puede seleccionar la misma opción que en "Empresa origen"
            if (empresaOrigen.value == empresaDestino.value) {
              errorEmpresasMigracion.style.display = 'block'
            } else {
              errorEmpresasMigracion.style.display = 'none'
            }
          }
          enableSaveButton()
        }
        empresaOrigen.addEventListener('focus', validateEmpresaOrigen)
        empresaOrigen.addEventListener('change', validateEmpresaOrigen)
      }
      
      // Validación empresa destino
      if (empresaDestino) {
        const validateEmpresaDestino = () => {
          if (empresaDestino.value == '') {
            errorEmpresaDestino.style.display = 'block'
            errorEmpresasMigracion.style.display = 'none'
          } else {
            errorEmpresaDestino.style.display = 'none'
            // No se puede seleccionar la misma opción que en "Empresa origen"
            if (empresaOrigen.value == empresaDestino.value) {
              errorEmpresasMigracion.style.display = 'block'
            } else {
              errorEmpresasMigracion.style.display = 'none'
            }
          }
          enableSaveButton()
        }
        empresaDestino.addEventListener('focus', validateEmpresaDestino)
        empresaDestino.addEventListener('change', validateEmpresaDestino)
      }
      
      // Validación nombre producto migracion
      if (nombreProductoMigracion) {
        const validateNombreProductoMigracion = () => {
          if (nombreProductoMigracion.value == '') {
            errorNombreProductoMigracion.style.display = 'block'
          }
          else {
            errorNombreProductoMigracion.style.display = 'none'
          }
  
          // Filtrando las opciones del catálogo que empiecen con el valor de nombre producto
          datalist.innerHTML = ''
          for (var i = 0; i < catalogoMaterial.length; i++) {
            if (catalogoMaterial[i].value.toUpperCase().startsWith(nombreProductoMigracion.value.toUpperCase())) {
              const option = document.createElement('option')
              option.value = catalogoMaterial[i].value
              option.innerText = catalogoMaterial[i].text
              datalist.appendChild(option)
            }
          }
          if (datalist.childElementCount == 0) {
            errorNombreProductoMigracion2.style.display = 'block'
            disableAllFieldsForMigracion()
          } else {
            errorNombreProductoMigracion2.style.display = 'none'
            enableAllFieldsForMigracion()
          }
          enableSaveButton()
  
          // Change
          let showError = true
          for (var i = 0; i < catalogoMaterial.length; i++) {
            if (catalogoMaterial[i].value.toUpperCase() == nombreProductoMigracion.value.toUpperCase()) {
              showError = false
              break
            }
          }
          if (showError) {
            errorNombreProductoMigracion2.style.display = 'block'
            disableAllFieldsForMigracion()
          } else {
            errorNombreProductoMigracion2.style.display = 'none'
            enableAllFieldsForMigracion()
          }
          enableSaveButton()
        }
  
        const validateNombreProductoMigracionOnChange = () => {
          if (nombreProductoMigracion.value == '') {
            errorNombreProductoMigracion.style.display = 'block'
          }
          else {
            errorNombreProductoMigracion.style.display = 'none'
          }
  
          // Solo la primera letra será mayúscula
          nombreProductoMigracion.value = nombreProductoMigracion.value != '' ? firstLetterCapitalized(nombreProductoMigracion.value) : ''
  
          // Filtrando las opciones del catálogo que empiecen con el valor de nombre producto
          datalist.innerHTML = ''
          for (var i = 0; i < catalogoMaterial.length; i++) {
            if (catalogoMaterial[i].value.toUpperCase().startsWith(nombreProductoMigracion.value.toUpperCase())) {
              const option = document.createElement('option')
              option.value = catalogoMaterial[i].value
              option.innerText = catalogoMaterial[i].text
              datalist.appendChild(option)
            }
          }
          if (datalist.childElementCount == 0) {
            errorNombreProductoMigracion2.style.display = 'block'
            disableAllFieldsForMigracion()
          } else {
            errorNombreProductoMigracion2.style.display = 'none'
            enableAllFieldsForMigracion()
          }
          enableSaveButton()
  
          // Change
          let showError = true
          for (var i = 0; i < catalogoMaterial.length; i++) {
            if (catalogoMaterial[i].value.toUpperCase() == nombreProductoMigracion.value.toUpperCase()) {
              showError = false
              break
            }
          }
          if (showError) {
            errorNombreProductoMigracion2.style.display = 'block'
            disableAllFieldsForMigracion()
          } else {
            errorNombreProductoMigracion2.style.display = 'none'
            enableAllFieldsForMigracion()
          }
          enableSaveButton()
        }
        nombreProductoMigracion.addEventListener('focus', validateNombreProductoMigracion)
        nombreProductoMigracion.addEventListener('input', validateNombreProductoMigracion)
        nombreProductoMigracion.addEventListener('change', validateNombreProductoMigracionOnChange)
      }
    
      // Validación empresa
      if (empresa) {
        const validateEmpresa = () => {
          if (empresa.value == '') {
            errorEmpresa.style.display = 'block'
          } else {
            errorEmpresa.style.display = 'none'
          }
          enableSaveButton()
        }
        empresa.addEventListener('focus', validateEmpresa)
        empresa.addEventListener('change', validateEmpresa)
      }
      
      // Validación justificacion
      if (justificacion) {
        const validateJustificacion = () => {
          if (justificacion.value == '') {
            errorJustificacion.style.display = 'block'
          } else {
            errorJustificacion.style.display = 'none'
          }
          enableSaveButton()
        }
        const validateJustificacionOnChange = () => {
          // Solo la primera letra será mayúscula
          justificacion.value = justificacion.value != '' ? firstLetterCapitalized(justificacion.value) : ''
        }
        justificacion.addEventListener('focus', validateJustificacion)
        justificacion.addEventListener('input', validateJustificacion)
        justificacion.addEventListener('change', validateJustificacionOnChange)
      }

      const validarCamposMaterial = () => {
        
        // Validación tipo alta
        var tipoAltaInputs = document.querySelectorAll('.material-tipo-alta')
        tipoAltaInputs.forEach(input => {
            input.addEventListener('focus', () => {
                var tipoAltaValue = input.value
                var container = input.closest('.tipo-alta-container')
                var errorTipoAlta = container.querySelector('#error-tipo-alta')
                // Verificar si el campo está vacío
                if (tipoAltaValue == '') {
                  errorTipoAlta.style.display = 'block'
                } else {
                  errorTipoAlta.style.display = 'none'
                }
            })

            // Validando si es producto/servicio para mostrar u ocultar medidas, material y color
            const validateTipoAltaOnChange = () => {
              var tipoAltaValue = input.value
              var container = input.closest('.tipo-alta-container')
              var errorTipoAlta = container.querySelector('#error-tipo-alta')
              // Verificar si el campo está vacío
              if (tipoAltaValue == '') {
                errorTipoAlta.style.display = 'block'
              }
              else {
                errorTipoAlta.style.display = 'none'
                // Filtrar las subfamilias y unidades de medida dependiendo del tipo de alta
                const form = input.closest('.material-form')
                const subfamilia = form.querySelector('.select-subfamilia')
                const unidadMedida = form.querySelector('.select-unidad-medida')
                var cadenaSubfamilias = ''
                var cadenaUnidadesMedida = ''
                // Medidas, material y color no serán visibles para clientes
                const medidasContainer = form.querySelector('#medidas-container')
                const materialColorContainer = form.querySelector('#material-color-container')

                if (tipoAltaValue === 'Almacén') {
                  subfamiliasProductoList.forEach(item => {
                    if (item === ' Seleccione una opción') {
                      cadenaSubfamilias += `<option value selected>${item}</option>`
                      return
                    }
                    cadenaSubfamilias += `<option value="${item}">${item}</option>`
                  })
                  unidadesMedidaList.forEach(item => {
                    if (item === ' Seleccione una opción') {
                      cadenaUnidadesMedida += `<option value selected>${item}</option>`
                      return
                    }
                    if (item === 'Servicio') {
                      return
                    }
                    cadenaUnidadesMedida += `<option value="${item}">${item}</option>`
                  })
                  // Mostrando las medidas, material y color
                  medidasContainer.style.display = 'block'
                  materialColorContainer.style.display = 'flex'
                }
                if (tipoAltaValue === 'Servicio') {
                  subfamiliasServicioList.forEach(item => {
                    if (item === ' Seleccione una opción') {
                      cadenaSubfamilias += `<option value selected>${item}</option>`
                      return
                    }
                    cadenaSubfamilias += `<option value="${item}">${item}</option>`
                  })
                  cadenaUnidadesMedida = `<option value selected>Selecciona una opción</option>
                  <option value="Servicio">Servicio</option>`
                  // Ocultando las medidas, material y color
                  medidasContainer.style.display = 'none'
                  materialColorContainer.style.display = 'none'
                }
                subfamilia.innerHTML = cadenaSubfamilias
                unidadMedida.innerHTML = cadenaUnidadesMedida

                // Mostrando los errores de subfamilia y unidad de medida
                const errorSubfamilia = form.querySelector('#error-subfamilia')
                const errorUnidadMedida = form.querySelector('#error-unidad-medida')
                errorSubfamilia.style.display = 'block'
                errorUnidadMedida.style.display = 'block'
              }
            }
            input.addEventListener('change', validateTipoAltaOnChange)

            // Validando si es producto/servicio al cargar la página
            const validateTipoAltaOnLoad = () => {
              var tipoAltaValue = input.value
              var container = input.closest('.tipo-alta-container')
              var errorTipoAlta = container.querySelector('#error-tipo-alta')
              // Verificar si el campo está vacío
              if (tipoAltaValue == '') {
                errorTipoAlta.style.display = 'block'
              }
              else {
                errorTipoAlta.style.display = 'none'
                // Medidas, material y color no serán visibles para clientes
                const form = input.closest('.material-form')
                const medidasContainer = form.querySelector('#medidas-container')
                const materialColorContainer = form.querySelector('#material-color-container')

                if (tipoAltaValue === 'Almacén') {
                  // Mostrando las medidas, material y color
                  medidasContainer.style.display = 'block'
                  materialColorContainer.style.display = 'flex'
                }
                if (tipoAltaValue === 'Servicio') {
                  // Ocultando las medidas, material y color
                  medidasContainer.style.display = 'none'
                  materialColorContainer.style.display = 'none'
                }
              }
            }
            validateTipoAltaOnLoad()
        })

        // Validación código
        var codigoInputs = document.querySelectorAll('.material-codigo')
        codigoInputs.forEach(input => {
            const validateCodigo = () => {
                var codigoValue = input.value
                var container = input.closest('.codigo-container')
                var errorCodigo = container.querySelector('#error-codigo')
                // Verificar si el campo tiene menos de 8 caracteres
                if (codigoValue.length < 8) {
                  errorCodigo.style.display = 'block'
                } else {
                  errorCodigo.style.display = 'none'
                }
            }
            input.addEventListener('focus', validateCodigo)
            input.addEventListener('input', validateCodigo)
        })

        // Validación subfamilia
        var subfamiliaInputs = document.querySelectorAll('.material-subfamilia')
        subfamiliaInputs.forEach(input => {
            const validateSubfamilia = () => {
                var subfamiliaValue = input.value
                var container = input.closest('.subfamilia-container')
                var errorSubfamilia = container.querySelector('#error-subfamilia')
                // Verificar si el campo está vacío
                if (subfamiliaValue == '') {
                  errorSubfamilia.style.display = 'block'
                } else {
                  errorSubfamilia.style.display = 'none'
                }
            }
            input.addEventListener('focus', validateSubfamilia)
            input.addEventListener('change', validateSubfamilia)
        })

        // Validación nombre producto
        var nombreProductoInputs = document.querySelectorAll('.material-nombre')
        nombreProductoInputs.forEach(function(input) {
            input.setAttribute('list', 'opciones_material')
            const validateNombreProducto = () => {
                // Focus
                var nombreProductoValue = input.value
                var container = input.closest('.nombre-producto-container')
                var errorNombreProducto = container.querySelector('#error-nombre-producto')
                // Verificar si el campo está vacío
                if (nombreProductoValue == '') {
                  errorNombreProducto.style.display = 'block'
                } else {
                  errorNombreProducto.style.display = 'none'
                }

                // Input
                // Filtrando las opciones del catálogo que empiecen con el valor de nombre producto
                const nombreProductoContainer = input.closest('.nombre-producto-container')
                const errorNombreProducto2 = nombreProductoContainer.querySelector('#error-nombre-producto-2')
                datalist.innerHTML = ''
                for (var i = 0; i < catalogoMaterial.length; i++) {
                  if (catalogoMaterial[i].value.toUpperCase().startsWith(input.value.toUpperCase())) {
                    const option = document.createElement('option')
                    option.value = catalogoMaterial[i].value
                    option.innerText = catalogoMaterial[i].text
                    datalist.appendChild(option)
                  }
                }
                if (datalist.childElementCount == 0) {
                  errorNombreProducto2.style.display = 'none'
                  enableAllFields(input)
                } else {
                  errorNombreProducto2.style.display = 'block'
                  disableAllFields(input)
                }

                // Change
                let showError = false
                for (var i = 0; i < catalogoMaterial.length; i++) {
                  if (catalogoMaterial[i].value.toUpperCase() == input.value.toUpperCase()) {
                    showError = true
                    break
                  }
                }
                if (showError) {
                  errorNombreProducto2.style.display = 'block'
                  disableAllFields(input)
                } else {
                  errorNombreProducto2.style.display = 'none'
                  enableAllFields(input)
                }
            }

            const validateNombreProductoOnChange = () => {
              // Focus
              var nombreProductoValue = input.value
              var container = input.closest('.nombre-producto-container')
              var errorNombreProducto = container.querySelector('#error-nombre-producto')
              // Verificar si el campo está vacío
              if (nombreProductoValue == '') {
                errorNombreProducto.style.display = 'block'
              } else {
                errorNombreProducto.style.display = 'none'
              }
              
              // Solo la primera letra será mayúscula
              input.value = input.value != '' ? firstLetterCapitalized(input.value) : ''

              // Input
              // Filtrando las opciones del catálogo que empiecen con el valor de nombre producto
              const nombreProductoContainer = input.closest('.nombre-producto-container')
              const errorNombreProducto2 = nombreProductoContainer.querySelector('#error-nombre-producto-2')
              datalist.innerHTML = ''
              for (var i = 0; i < catalogoMaterial.length; i++) {
                if (catalogoMaterial[i].value.toUpperCase().startsWith(input.value.toUpperCase())) {
                  const option = document.createElement('option')
                  option.value = catalogoMaterial[i].value
                  option.innerText = catalogoMaterial[i].text
                  datalist.appendChild(option)
                }
              }
              if (datalist.childElementCount == 0) {
                errorNombreProducto2.style.display = 'none'
                enableAllFields(input)
              } else {
                errorNombreProducto2.style.display = 'block'
                disableAllFields(input)
              }

              // Change
              let showError = false
              for (var i = 0; i < catalogoMaterial.length; i++) {
                if (catalogoMaterial[i].value.toUpperCase() == input.value.toUpperCase()) {
                  showError = true
                  break
                }
              }
              if (showError) {
                errorNombreProducto2.style.display = 'block'
                disableAllFields(input)
              } else {
                errorNombreProducto2.style.display = 'none'
                enableAllFields(input)
              }
            }
            input.addEventListener('focus', validateNombreProducto)
            input.addEventListener('input', validateNombreProducto)
            input.addEventListener('change', validateNombreProductoOnChange)
        })

        // Validación foto producto
        var fotoProductoInputs = document.querySelectorAll('.material-foto-producto')
        fotoProductoInputs.forEach(input => {
            const validateFotoProducto = () => {
                const fotoProductoContainer = input.closest('.foto-producto-container')
                const imagePreviewContainer = fotoProductoContainer.querySelector('#image_preview_container')
                const imagePreview = fotoProductoContainer.querySelector('#id_foto_producto_img')
                const deleteImagePreview = fotoProductoContainer.querySelector('#id_btn_delete_foto_producto')
                const imageDownload = fotoProductoContainer.querySelector('#id_foto_producto_download')
                if (input.files && input.files[0]) {
                    var reader = new FileReader()
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result
                        imageDownload.href = e.target.result
                    };
                    reader.readAsDataURL(input.files[0]);
                    imagePreviewContainer.style.display = 'flex'
                    imageDownload.style.display = 'block'
                }
                else {
                    imagePreview.src = ''
                    imagePreviewContainer.style.display = 'none'
                    imageDownload.src = ''
                    imageDownload.style.display = 'none'
                }
            }
            input.addEventListener('change', validateFotoProducto)
        })

        // Validación eliminar foto producto
        var deleteFotoProductoButtons = document.querySelectorAll('.btn-delete-foto-producto')
        deleteFotoProductoButtons.forEach(input => {
            const deleteFotoProducto = () => {
                const fotoProductoContainer = input.closest('.foto-producto-container')
                const fotoProducto = fotoProductoContainer.querySelector('.material-foto-producto')
                const imagePreviewContainer = fotoProductoContainer.querySelector('#image_preview_container')
                const imagePreview = fotoProductoContainer.querySelector('#id_foto_producto_img')
                
                // Crear un nuevo campo de entrada de tipo "file"
                var newfotoProducto = document.createElement('input')
                newfotoProducto.type = 'file'
                newfotoProducto.name = fotoProducto.name
                newfotoProducto.classList.add('form-file')
                newfotoProducto.classList.add('material-foto-producto')
                newfotoProducto.accept = 'image/*'
                newfotoProducto.id = fotoProducto.id
                // Reemplazar el campo de entrada original con el nuevo
                fotoProductoContainer.replaceChild(newfotoProducto, fotoProducto)

                imagePreview.src = ''
                imagePreviewContainer.style.display = 'none'
            }
            input.addEventListener('click', deleteFotoProducto)
        })

        // Validación ficha técnica
        var fichaTecnicaInputs = document.querySelectorAll('.material-ficha-tecnica')
        fichaTecnicaInputs.forEach(input => {
            const fichaTecnicaContainer = input.closest('.ficha-tecnica-container')
            const imagePreviewContainer = fichaTecnicaContainer.querySelector('#image_preview_container')
            const imagePreview = fichaTecnicaContainer.querySelector('#id_ficha_tecnica_img')
            const imageDownload = fichaTecnicaContainer.querySelector('#id_ficha_tecnica_download')
            const validateFichaTecnica = () => {
                if (input.files && input.files[0]) {
                    var reader = new FileReader()
                    reader.onload = function(e) {
                        if (input.files[0].type.startsWith('image/')) {
                            imagePreview.src = e.target.result
                            imageDownload.href = e.target.result
                        }
                        else {
                            imagePreview.src = '../../../static/images/pdf-default.png'
                            imageDownload.href = e.target.result
                        }
                    }
                    reader.readAsDataURL(input.files[0])
                    imagePreviewContainer.style.display = 'flex'
                    imageDownload.style.display = 'block'
                }
                else {
                    imagePreview.src = ''
                    if (imagePreviewContainer) {
                      imagePreviewContainer.style.display = 'none'
                    }
                    imageDownload.src = ''
                    imageDownload.style.display = 'none'
                }
            }

            const isImage = url => {
              return(url.match(/\.(jpeg|jpg|gif|png)$/) != null)
            }

            const validateFichaTecnicaOnLoad = () => {
                if (imagePreview.src.includes('static')) {
                    if (!isImage(imagePreview.src)) {
                      imagePreview.src = '../../../static/images/pdf-default.png'
                    }
                    imagePreviewContainer.style.display = 'flex'
                    imageDownload.style.display = 'block'
                }
                else {
                    imagePreview.src = ''
                    if (imagePreviewContainer) {
                      imagePreviewContainer.style.display = 'none'
                      imageDownload.src = ''
                      imageDownload.style.display = 'none'
                    }
                }
            }
            input.addEventListener('change', validateFichaTecnica)
            validateFichaTecnicaOnLoad()
        })

        // Validación eliminar ficha técnica
        var deleteFichaTecnicaButtons = document.querySelectorAll('.btn-delete-ficha-tecnica')
        deleteFichaTecnicaButtons.forEach(input => {
            const deleteFichaTecnica = () => {
                const fichaTecnicaContainer = input.closest('.ficha-tecnica-container')
                const fichaTecnica = fichaTecnicaContainer.querySelector('.material-ficha-tecnica')
                const imagePreviewContainer = fichaTecnicaContainer.querySelector('#image_preview_container')
                const imagePreview = fichaTecnicaContainer.querySelector('#id_ficha_tecnica_img')
                fichaTecnica.value = ''
                imagePreview.src = ''
                imagePreviewContainer.style.display = 'none'
            }
            input.addEventListener('click', deleteFichaTecnica)
        })

        // Validación largo
        var largoInputs = document.querySelectorAll('.material-largo')
        largoInputs.forEach(input => {
            const validateLargo = () => {
                var largoValue = input.value
                var container = input.closest('.largo-container')
                var errorLargo = container.querySelector('#error-largo')
                // Verificar si el valor es "N/A", numérico o fracción
                if (largoValue === 'N/A' || 
                  !isNaN(parseFloat(largoValue)) && isFinite(largoValue) || 
                  fraccionPattern.test(largoValue)) {
                    errorLargo.style.display = 'none'
                    enableAllFields(input)
                    if (largoValue === 'N/A') {
                      const medidasContainer = input.closest('#medidas-container')
                      const medidaLargo = medidasContainer.querySelector('#select-largo')
                      const labelLargo = medidasContainer.querySelector('#label-largo')
                      medidaLargo.value = ''
                      labelLargo.style.display = 'block'
                      labelLargo.innerHTML = 'No aplica'
                    }
                } else {
                    errorLargo.style.display = 'block'
                    disableAllFields(input)
                }
            }
            input.addEventListener('input', validateLargo)

            input.addEventListener('focus', () => {
              validateLargo()
              var medidasContainer = input.closest('#medidas-container')
              var selectLargo = medidasContainer.querySelector('#select-largo')
              var selectAncho = medidasContainer.querySelector('#select-ancho')
              var selectAlto = medidasContainer.querySelector('#select-alto')
              selectLargo.style.display = 'block'
              selectAncho.style.display = 'none'
              selectAlto.style.display = 'none'
              
              var largoValue = input.value
              var container = input.closest('.largo-container')
              var errorLargo = container.querySelector('#error-largo')
              // Verificar si el valor es "N/A", numérico o fracción
              if (largoValue === 'N/A' || 
                !isNaN(parseFloat(largoValue)) && isFinite(largoValue) || 
                fraccionPattern.test(largoValue)) {
                  errorLargo.style.display = 'none'
                  enableAllFields(input)
              } else {
                  errorLargo.style.display = 'block'
                  disableAllFields(input)
              }
            })
            input.addEventListener('change', () => {
              input.value = input.value.toUpperCase()
            })
        })

        // Validación ancho
        var anchoInputs = document.querySelectorAll('.material-ancho')
        anchoInputs.forEach(input => {
            const validateAncho = () => {
                var anchoValue = input.value
                var container = input.closest('.ancho-container')
                var errorAncho = container.querySelector('#error-ancho')
                // Verificar si el valor es "N/A", numérico o fracción
                if (anchoValue === 'N/A' || 
                  !isNaN(parseFloat(anchoValue)) && isFinite(anchoValue) || 
                  fraccionPattern.test(anchoValue)) {
                    errorAncho.style.display = 'none'
                    enableAllFields(input)
                    const medidasContainer = input.closest('#medidas-container')
                    const medidaAncho = medidasContainer.querySelector('.select-um-ancho')
                    const labelAncho = medidasContainer.querySelector('#label-ancho')
                    labelAncho.style.display = 'block'
                    if (anchoValue === 'N/A') {
                      medidaAncho.value = ''
                      labelAncho.innerHTML = 'No aplica'
                    }
                    else {
                      if (medidasIguales) {
                        const medidaLargo = medidasContainer.querySelector('.select-um-largo')
                        medidaAncho.value = medidaLargo.value
                        labelAncho.innerHTML = medidaAncho.value
                      }
                    }
                } else {
                    errorAncho.style.display = 'block'
                    disableAllFields(input)
                }
            }
            input.addEventListener('input', validateAncho)
            input.addEventListener('focus', () => {
              validateAncho()
              if (!medidasIguales) {
                var medidasContainer = input.closest('#medidas-container')
                var selectLargo = medidasContainer.querySelector('#select-largo')
                var selectAncho = medidasContainer.querySelector('#select-ancho')
                var selectAlto = medidasContainer.querySelector('#select-alto')
                selectLargo.style.display = 'none'
                selectAncho.style.display = 'block'
                selectAlto.style.display = 'none'
                
                var anchoValue = input.value
                var container = input.closest('.ancho-container')
                var errorAncho = container.querySelector('#error-ancho')
                // Verificar si el valor es "N/A", numérico o fracción
                if (anchoValue === 'N/A' || 
                  !isNaN(parseFloat(anchoValue)) && isFinite(anchoValue) || 
                  fraccionPattern.test(anchoValue)) {
                    errorAncho.style.display = 'none'
                    enableAllFields(input)
                } else {
                    errorAncho.style.display = 'block'
                    disableAllFields(input)
                }
              }
            })
            input.addEventListener('change', () => {
              input.value = input.value.toUpperCase()
            })
        })

        // Validación alto
        var altoInputs = document.querySelectorAll('.material-alto')
        altoInputs.forEach(input => {
            const validateAlto = () => {
                var altoValue = input.value
                var container = input.closest('.alto-container')
                var errorAlto = container.querySelector('#error-alto')
                // Verificar si el valor es "N/A", numérico o fracción
                if (altoValue === 'N/A' || 
                  !isNaN(parseFloat(altoValue)) && isFinite(altoValue) || 
                  fraccionPattern.test(altoValue)) {
                    errorAlto.style.display = 'none'
                    enableAllFields(input)
                    const medidasContainer = input.closest('#medidas-container')
                    const medidaAlto = medidasContainer.querySelector('.select-um-alto')
                    const labelAlto = medidasContainer.querySelector('#label-alto')
                    labelAlto.style.display = 'block'
                    if (altoValue === 'N/A') {
                      medidaAlto.value = ''
                      labelAlto.innerHTML = 'No aplica'
                    }
                    else {
                      if (medidasIguales) {
                        const medidaLargo = medidasContainer.querySelector('.select-um-largo')
                        medidaAlto.value = medidaLargo.value
                        labelAlto.innerHTML = medidaAlto.value
                      }
                    }
                } else {
                    errorAlto.style.display = 'block'
                    disableAllFields(input)
                }
            }
            input.addEventListener('input', validateAlto)
            input.addEventListener('focus', () => {
              validateAlto()
              if (!medidasIguales) {
                var medidasContainer = input.closest('#medidas-container')
                var selectLargo = medidasContainer.querySelector('#select-largo')
                var selectAncho = medidasContainer.querySelector('#select-ancho')
                var selectAlto = medidasContainer.querySelector('#select-alto')
                selectLargo.style.display = 'none'
                selectAncho.style.display = 'none'
                selectAlto.style.display = 'block'

                var altoValue = input.value
                var container = input.closest('.alto-container')
                var errorAlto = container.querySelector('#error-alto')
                // Verificar si el valor es "N/A", numérico o fracción
                if (altoValue === 'N/A' || 
                  !isNaN(parseFloat(altoValue)) && isFinite(altoValue) || 
                  fraccionPattern.test(altoValue)) {
                    errorAlto.style.display = 'none'
                    enableAllFields(input)
                } else {
                    errorAlto.style.display = 'block'
                    disableAllFields(input)
                }
              }
            })
            input.addEventListener('change', () => {
              input.value = input.value.toUpperCase()
            })
        })
        
        // Validación medidas iguales
        const mismaMedidaInputs = document.querySelectorAll('.medidas-iguales')
        mismaMedidaInputs.forEach(input => {
          const unidadesMedidaContainer = input.closest('#id-unidades-medida')

          // Al cargar la pagina, verificar si las medidas son iguales para marcar la casilla
          const validateMedidasIguales = () => {
            const umLargo = unidadesMedidaContainer.querySelector('.material-um-largo')
            const umAncho = unidadesMedidaContainer.querySelector('.material-um-ancho')
            const umAlto = unidadesMedidaContainer.querySelector('.material-um-alto')
            if (umLargo.value == umAncho.value && umLargo.value == umAlto.value) {
              input.checked = true
              unidadesMedidaContainer.querySelector('#select-largo').style.display = 'block'
              unidadesMedidaContainer.querySelector('#select-ancho').style.display = 'none'
              unidadesMedidaContainer.querySelector('#select-alto').style.display = 'none'
              medidasIguales = true
            }
          }
          validateMedidasIguales()

          input.addEventListener('change', () => {
            if (input.checked) {
              var largo = unidadesMedidaContainer.querySelector('.select-um-largo')
              var ancho = unidadesMedidaContainer.querySelector('.select-um-ancho')
              var alto = unidadesMedidaContainer.querySelector('.select-um-alto')
              ancho.value = largo.value
              alto.value = largo.value
              unidadesMedidaContainer.querySelector('#select-largo').style.display = 'block'
              unidadesMedidaContainer.querySelector('#select-ancho').style.display = 'none'
              unidadesMedidaContainer.querySelector('#select-alto').style.display = 'none'
              medidasIguales = true
            }
            else {
              medidasIguales = false
            }
          })
        })

        // Validación unidad de medida para largo
        var umLargoInputs = document.querySelectorAll('.select-um-largo')
        umLargoInputs.forEach(input => {
          const medidasContainer = input.closest('#medidas-container')

          input.addEventListener('change', () => {
            const largo = medidasContainer.querySelector('.material-largo')
            const labelLargo = medidasContainer.querySelector('#label-largo')
            labelLargo.style.display = 'block'
            if (largo.value === 'N/A') {
              labelLargo.innerText = 'No aplica'
            } else {
              labelLargo.innerText = input.value
            }

            // Verificar si la casilla de medidas iguales está marcada
            medidasIguales = medidasContainer.querySelector('#id-medidas-iguales').checked
            if (medidasIguales) {
              const ancho = medidasContainer.querySelector('.material-ancho')
              const alto = medidasContainer.querySelector('.material-alto')
              const umAncho = medidasContainer.querySelector('.select-um-ancho')
              const umAlto = medidasContainer.querySelector('.select-um-alto')
              umAncho.value = input.value
              umAlto.value = input.value
              
              const labelAncho = medidasContainer.querySelector('#label-ancho')
              if (labelAncho) {
                labelAncho.style.display = 'block'
              }
              if (ancho.value === 'N/A') {
                labelAncho.innerText = 'No aplica'
              } else {
                labelAncho.innerText = umAncho.value
              }
              
              const labelAlto = medidasContainer.querySelector('#label-alto')
              labelAlto.style.display = 'block'
              if (alto.value === 'N/A') {
                labelAlto.innerText = 'No aplica'
              } else {
                labelAlto.innerText = umAlto.value
              }
            }
          })
        })

        // Validación unidad de medida para ancho
        var umAnchoInputs = document.querySelectorAll('.select-um-ancho')
        umAnchoInputs.forEach(input => {
          input.addEventListener('change', () => {
            const medidasContainer = input.closest('#medidas-container')
            const ancho = medidasContainer.querySelector('.material-ancho')
            const labelAncho = medidasContainer.querySelector('#label-ancho')
            labelAncho.style.display = 'block'
            if (ancho.value === 'N/A') {
              labelAncho.innerText = 'No aplica'
            } else {
              labelAncho.innerText = input.value
            }
          })
        })

        // Validación unidad de medida para alto
        var umAltoInputs = document.querySelectorAll('.select-um-alto')
        umAltoInputs.forEach(input => {
          input.addEventListener('change', () => {
            const medidasContainer = input.closest('#medidas-container')
            const alto = medidasContainer.querySelector('.material-alto')
            const labelAlto = medidasContainer.querySelector('#label-alto')
            labelAlto.style.display = 'block'
            if (alto.value === 'N/A') {
              labelAlto.innerText = 'No aplica'
            } else {
              labelAlto.innerText = input.value
            }
          })
        })

        // Validación material
        var materialInputs = document.querySelectorAll('.material-material')
        materialInputs.forEach(input => {
            const validateMaterial = () => {
                var materialValue = input.value
                var container = input.closest('.material-container')
                var errorMaterial = container.querySelector('#error-material')
                if (materialValue == '') {
                    errorMaterial.style.display = 'block'
                    disableAllFields(input)
                } else {
                    errorMaterial.style.display = 'none'
                    enableAllFields(input)
                }
            }
            const validateMaterialOnChange = () => {
                // Solo la primera letra será mayúscula
                input.value = input.value != '' ? firstLetterCapitalized(input.value) : ''
            }
            input.addEventListener('focus', validateMaterial)
            input.addEventListener('input', validateMaterial)
            input.addEventListener('change', validateMaterialOnChange)
        })

        // Validación color
        var colorInputs = document.querySelectorAll('.material-color')
        colorInputs.forEach(input => {
            const validateColor = () => {
                var colorValue = input.value
                var container = input.closest('.color-container')
                var errorColor = container.querySelector('#error-color')
                if (colorValue == '') {
                    errorColor.style.display = 'block'
                    disableAllFields(input)
                } else {
                    errorColor.style.display = 'none'
                    enableAllFields(input)
                }
            }
            const validateColorOnChange = () => {
              // Solo la primera letra será mayúscula
              input.value = input.value != '' ? firstLetterCapitalized(input.value) : ''
          }
            input.addEventListener('focus', validateColor)
            input.addEventListener('input', validateColor)
            input.addEventListener('change', validateColorOnChange)
        })

        // Validación marca
        var marcaInputs = document.querySelectorAll('.material-marca')
        marcaInputs.forEach(input => {
            const validateColor = () => {
                // Solo la primera letra será mayúscula
                input.value = input.value != '' ? firstLetterOfEachWordCapitalized(input.value) : ''
            }
            input.addEventListener('change', validateColor)
        })

        // Validación nombre común
        var nombreComunInputs = document.querySelectorAll('.material-nombre-comun')
        nombreComunInputs.forEach(input => {
            const validateNombreComun = () => {
                // Solo la primera letra será mayúscula
                input.value = input.value != '' ? firstLetterCapitalized(input.value) : ''
            }
            input.addEventListener('change', validateNombreComun)
        })

        // Validación porcentaje de IVA
        var porcentajeIvaInputs = document.querySelectorAll('.material-porcentaje-iva')
        porcentajeIvaInputs.forEach(input => {
            const validatePorcentajeIva = () => {
                var porcentajeIvaValue = input.value
                var container = input.closest('.porcentaje-iva-container')
                var errorPorcentajeIva = container.querySelector('#error-porcentaje-iva')
                // Verificar si el campo está vacío
                if (porcentajeIvaValue == '') {
                  errorPorcentajeIva.style.display = 'block'
                } else {
                  errorPorcentajeIva.style.display = 'none'
                }
            }
            input.addEventListener('focus', validatePorcentajeIva)
            input.addEventListener('change', validatePorcentajeIva)
        })

        // Validación alias
        var aliasInputs = document.querySelectorAll('.material-alias')
        aliasInputs.forEach(input => {
            const validateAlias = () => {
                // Solo la primera letra será mayúscula
                input.value = input.value != '' ? firstLetterCapitalized(input.value) : ''
            }
            input.addEventListener('change', validateAlias)
        })

        // Validación unidad de medida
        var unidadMedidaInputs = document.querySelectorAll('.material-unidad-medida')
        unidadMedidaInputs.forEach(input => {
            const validateUnidadMedida = () => {
                var unidadMedidaValue = input.value
                var container = input.closest('.unidad-medida-container')
                var errorUnidadMedida = container.querySelector('#error-unidad-medida')
                // Verificar si el campo está vacío
                if (unidadMedidaValue == '') {
                  errorUnidadMedida.style.display = 'block'
                } else {
                  errorUnidadMedida.style.display = 'none'
                }
            }
            input.addEventListener('focus', validateUnidadMedida)
            input.addEventListener('change', validateUnidadMedida)
        })

        const disableAllFields = input => {
          const tableButtons = tableMaterials.querySelectorAll('a, button')
          const form = input.closest('.material-form')
          const tipoAlta = form.querySelector('.material-tipo-alta')
          const subfamilia = form.querySelector('.material-subfamilia')
          const nombre = form.querySelector('.material-nombre')
          const fotoProductoInput = form.querySelector('.material-foto-producto')
          const fotoProductoImg = form.querySelector('#id_foto_producto_img')
          const fotoProductoDownload = form.querySelector('#id_foto_producto_download')
          const fichaTecnicaInput = form.querySelector('.material-ficha-tecnica')
          const fichaTecnicaImg = form.querySelector('#id_ficha_tecnica_img')
          const fichaTecnicaDownload = form.querySelector('#id_ficha_tecnica_download')
          const largo = form.querySelector('.material-largo')
          const ancho = form.querySelector('.material-ancho')
          const alto = form.querySelector('.material-alto')
          const medidasIguales = form.querySelector('.medidas-iguales')
          const umLargo = form.querySelector('.material-um-largo')
          const umAncho = form.querySelector('.material-um-ancho')
          const umAlto = form.querySelector('.material-um-alto')
          const material = form.querySelector('.material-material')
          const color = form.querySelector('.material-color')
          const marca = form.querySelector('.material-marca')
          const parteModelo = form.querySelector('.material-parte-modelo')
          const nombreComun = form.querySelector('.material-nombre-comun')
          const ingActivo = form.querySelector('.material-ing-activo')
          const porcentajeIva = form.querySelector('.material-porcentaje-iva')
          const alias = form.querySelector('.material-alias')
          const unidadMedida = form.querySelector('.material-unidad-medida')
          const codigoSat = form.querySelector('.material-codigo-sat')
          const esMezcla = form.querySelector('.material-es-mezcla')
          const esMaterialEmpaque = form.querySelector('.material-es-material-empaque')
          const esProdTerminado = form.querySelector('.material-es-prod-terminado')
          const saveChanges = form.querySelector('.btn-save-changes')

          tableButtons.forEach(button => {
            button.setAttribute('disabled', true)
          })
          tipoAlta.setAttribute('disabled', true)
          subfamilia.setAttribute('disabled', true)
          if (!input.classList.contains('material-nombre')) {
            nombre.setAttribute('disabled', true)
          }
          fotoProductoInput.setAttribute('disabled', true)
          fotoProductoImg.style.opacity = 0.5
          if (fotoProductoDownload) {
            fotoProductoDownload.style.display = 'none'
          }
          fichaTecnicaInput.setAttribute('disabled', true)
          fichaTecnicaImg.style.opacity = 0.5
          if (fichaTecnicaDownload) {
            fichaTecnicaDownload.style.display = 'none'
          }
          if (!input.classList.contains('material-largo')) {
            largo.setAttribute('disabled', true)
          }
          if (!input.classList.contains('material-ancho')) {
            ancho.setAttribute('disabled', true)
          }
          if (!input.classList.contains('material-alto')) {
            alto.setAttribute('disabled', true)
          }
          medidasIguales.setAttribute('disabled', true)
          umLargo.setAttribute('disabled', true)
          umAncho.setAttribute('disabled', true)
          umAlto.setAttribute('disabled', true)
          if (!input.classList.contains('material-material')) {
            material.setAttribute('disabled', true)
          }
          if (!input.classList.contains('material-color')) {
            color.setAttribute('disabled', true)
          }
          marca.setAttribute('disabled', true)
          parteModelo.setAttribute('disabled', true)
          nombreComun.setAttribute('disabled', true)
          ingActivo.setAttribute('disabled', true)
          porcentajeIva.setAttribute('disabled', true)
          alias.setAttribute('disabled', true)
          unidadMedida.setAttribute('disabled', true)
          codigoSat.setAttribute('disabled', true)
          esMezcla.setAttribute('disabled', true)
          esMaterialEmpaque.setAttribute('disabled', true)
          esProdTerminado.setAttribute('disabled', true)
          if (saveChanges) {
            saveChanges.setAttribute('disabled', true)
          }
        }

        const enableAllFields = input => {
          const tableButtons = tableMaterials.querySelectorAll('a, button')
          const form = input.closest('.material-form')
          const tipoAlta = form.querySelector('.material-tipo-alta')
          const subfamilia = form.querySelector('.material-subfamilia')
          const nombre = form.querySelector('.material-nombre')
          const fotoProductoInput = form.querySelector('.material-foto-producto')
          const fotoProductoImg = form.querySelector('#id_foto_producto_img')
          const fotoProductoDownload = form.querySelector('#id_foto_producto_download')
          const fichaTecnicaInput = form.querySelector('.material-ficha-tecnica')
          const fichaTecnicaImg = form.querySelector('#id_ficha_tecnica_img')
          const fichaTecnicaDownload = form.querySelector('#id_ficha_tecnica_download')
          const largo = form.querySelector('.material-largo')
          const ancho = form.querySelector('.material-ancho')
          const alto = form.querySelector('.material-alto')
          const medidasIguales = form.querySelector('.medidas-iguales')
          const umLargo = form.querySelector('.material-um-largo')
          const umAncho = form.querySelector('.material-um-ancho')
          const umAlto = form.querySelector('.material-um-alto')
          const material = form.querySelector('.material-material')
          const color = form.querySelector('.material-color')
          const marca = form.querySelector('.material-marca')
          const parteModelo = form.querySelector('.material-parte-modelo')
          const nombreComun = form.querySelector('.material-nombre-comun')
          const ingActivo = form.querySelector('.material-ing-activo')
          const porcentajeIva = form.querySelector('.material-porcentaje-iva')
          const alias = form.querySelector('.material-alias')
          const unidadMedida = form.querySelector('.material-unidad-medida')
          const codigoSat = form.querySelector('.material-codigo-sat')
          const esMezcla = form.querySelector('.material-es-mezcla')
          const esMaterialEmpaque = form.querySelector('.material-es-material-empaque')
          const esProdTerminado = form.querySelector('.material-es-prod-terminado')
          const saveChanges = form.querySelector('.btn-save-changes')
          
          tableButtons.forEach(button => {
            button.removeAttribute('disabled')
          })
          tipoAlta.removeAttribute('disabled')
          subfamilia.removeAttribute('disabled')
          nombre.removeAttribute('disabled')
          fotoProductoInput.removeAttribute('disabled')
          fotoProductoImg.style.opacity = 1
          if (fotoProductoDownload) {
            fotoProductoDownload.style.display = 'block'
          }
          fichaTecnicaInput.removeAttribute('disabled')
          fichaTecnicaImg.style.opacity = 1
          if (fichaTecnicaDownload) {
            fichaTecnicaDownload.style.display = 'block'
          }
          largo.removeAttribute('disabled')
          ancho.removeAttribute('disabled')
          alto.removeAttribute('disabled')
          medidasIguales.removeAttribute('disabled')
          umLargo.removeAttribute('disabled')
          umAncho.removeAttribute('disabled')
          umAlto.removeAttribute('disabled')
          material.removeAttribute('disabled')
          color.removeAttribute('disabled')
          marca.removeAttribute('disabled')
          parteModelo.removeAttribute('disabled')
          nombreComun.removeAttribute('disabled')
          ingActivo.removeAttribute('disabled')
          porcentajeIva.removeAttribute('disabled')
          alias.removeAttribute('disabled')
          unidadMedida.removeAttribute('disabled')
          codigoSat.removeAttribute('disabled')
          esMezcla.removeAttribute('disabled')
          esMaterialEmpaque.removeAttribute('disabled')
          esProdTerminado.removeAttribute('disabled')
          if (saveChanges) {
            saveChanges.removeAttribute('disabled')
          }
        }
      }

      validarCamposMaterial()

      const fillTable = () => {
        materialCounter = 0
        bodyMaterials.innerHTML = ''
        const materialForms = document.querySelectorAll('.material-form')
        materialForms.forEach((materialForm, index) => {
          const codigo = materialForm.querySelector('.material-codigo')
          const tipoAlta = materialForm.querySelector('.material-tipo-alta')
          const subfamilia = materialForm.querySelector('.material-subfamilia')
          const nombre = materialForm.querySelector('.material-nombre')
          const fotoProducto = materialForm.querySelector('#id_foto_producto_img')
          const fichaTecnica = materialForm.querySelector('#id_ficha_tecnica_img')
          const largo = materialForm.querySelector('.material-largo')
          const ancho = materialForm.querySelector('.material-ancho')
          const alto = materialForm.querySelector('.material-alto')
          const umLargo = materialForm.querySelector('.material-um-largo')
          const umAncho = materialForm.querySelector('.material-um-ancho')
          const umAlto = materialForm.querySelector('.material-um-alto')
          const material = materialForm.querySelector('.material-material')
          const color = materialForm.querySelector('.material-color')
          const marca = materialForm.querySelector('.material-marca')
          const parteModelo = materialForm.querySelector('.material-parte-modelo')
          const nombreComun = materialForm.querySelector('.material-nombre-comun')
          const ingActivo = materialForm.querySelector('.material-ing-activo')
          const porcentajeIva = materialForm.querySelector('.material-porcentaje-iva')
          const alias = materialForm.querySelector('.material-alias')
          const unidadMedida = materialForm.querySelector('.material-unidad-medida')
          const codigoSat = materialForm.querySelector('.material-codigo-sat')
          const esMezcla = materialForm.querySelector('.material-es-mezcla')
          const esMaterialEmpaque = materialForm.querySelector('.material-es-material-empaque')
          const esProdTerminado = materialForm.querySelector('.material-es-prod-terminado')
  
          esMezclaValue = esMezcla.checked == true ? 'Si' : 'No'
          esMaterialEmpaqueValue = esMaterialEmpaque.checked == true ? 'Si' : 'No'
          esProdTerminadoValue = esProdTerminado.checked == true ? 'Si' : 'No'

          const rechazado = materialForm.querySelector('.material-rechazado')

          if (tipoAlta.value && subfamilia.value && nombre.value && porcentajeIva.value && unidadMedida.value) {
            materialCounter++
            const newRow = bodyMaterials.insertRow()
            newRow.classList.add('table-row')

            if (rechazado && rechazado.value == 'true') {
              newRow.classList.add('table-row-hidden')
              materialCounter--
            }

            const isImage = url => {
              if (url.includes('image')) {
                return true
              }
              return(url.match(/\.(jpeg|jpg|gif|png)$/) != null)
            }

            newRow.id = `table-row-${index}`
            if (codigo) {
              newRow.innerHTML = `<td>${codigo.value}</td>`
            }
            else {
              newRow.innerHTML = ``
            }
            newRow.innerHTML += `
            <td>${tipoAlta.value}</td>
            <td>${subfamilia.value}</td>
            <td>${nombre.value}</td>`
            if (isImage(fotoProducto.src)) {
              newRow.innerHTML += `
              <td class="p-0"><img style="width: auto; max-height: 4rem" src="${fotoProducto.src}" alt="Foto del producto"/></td>`
            }
            else {
              newRow.innerHTML += `
              <td class="p-0"><p>Sin imagen</p></td>`
            }
            if (isImage(fichaTecnica.src)) {
              newRow.innerHTML += `
              <td class="p-0"><img style="width: auto; max-height: 4rem" src="${fichaTecnica.src}" alt="Foto del producto"/></td>`
            }
            else {
              newRow.innerHTML += `
              <td class="p-0"><p>Sin imagen</p></td>`
            }
            newRow.innerHTML += `
            <td>${largo.value}<br />${umLargo.value}</td>
            <td>${ancho.value}<br />${umAncho.value}</td>
            <td>${alto.value}<br />${umAlto.value}</td>
            <td>${material.value}</td>
            <td>${color.value}</td>
            <td>${marca.value}</td>
            <td>${parteModelo.value}</td>
            <td>${nombreComun.value}</td>
            <td>${ingActivo.value}</td>
            <td>${porcentajeIva.value}</td>
            <td>${alias.value}</td>
            <td>${unidadMedida.value}</td>
            <td>${codigoSat.value}</td>
            <td>${esMezclaValue}</td>
            <td>${esMaterialEmpaqueValue}</td>
            <td>${esProdTerminadoValue}</td>
            <td>
              <button id="edit-material-${index}" class="btn btn-primary edit-material" type="button" style="font-size:0.8rem">Abrir</button>
            </td>
            <td>
              <button id="remove-material-${index}" class="btn btn-danger remove-material" type="button" style="font-size:0.8rem">Eliminar</button>
            </td>`
          }
        })

        disableRemoveButtons()
      }

      if (tableMaterials) {
        fillTable()

        tableMaterials.addEventListener('click', function(event) {

          // Editar material
          if (event.target && event.target.classList.contains('edit-material')) {
            // Llenar la tabla con la información actualizada
            fillTable()
            // Deshabilitando los botones Editar
            const editButtons = tableMaterials.querySelectorAll('.edit-material');
            editButtons.forEach(editButton => {
              editButton.setAttribute('disabled', true)
            })
            event.target.disabled = true
            // Mostrar el formulario seleccionado
            const forms = document.getElementsByClassName('material-form');
            for (let i = 0; i < forms.length; i++) {
              forms[i].style.display = 'none'
            }
            editingId = event.target.id.substring(14, event.target.id.length)
            const form = document.getElementById(`material-form-${editingId}`)
            if (form) {
              form.style.display = "block"
              medidasIguales = false
            }

            // Deshabilitar botones de tipo submit. Se habilitarán al hacer clic en "Guardar cambios"
            if (btnSave) {
              btnSave.setAttribute('disabled', true)
              btnRemove.setAttribute('disabled', true)
            }
            if (btnApprove) {
              btnApprove.setAttribute('disabled', true)
              btnDecline.setAttribute('disabled', true)
            }
          }

          // Eliminar material
          if (event.target && event.target.classList.contains('remove-material')) {
            removeId = event.target.id.substring(16, event.target.id.length)
            const form = document.getElementById(`material-form-${removeId}`)
            if (form) {
              // Si el usuario es el requisitor, se elimina el producto de la tabla
              {% if current_user.id == solicitud.usuario.id %}
                form.remove()
                // Recorre todos los formularios restantes y actualiza sus índices
                const forms = materialFormsContainer.querySelectorAll('.material-form');
                var counter = 0
                forms.forEach(form => {
                  form.id = `material-form-${counter}`
                  const inputs = form.querySelectorAll('[id^=id_material-]');
                  for (let j = 0; j < inputs.length; j++) {
                    inputs[j].id = inputs[j].id.replace(/\d+/, i);
                  }
                  form.style.display = 'none'
                  counter++
                })
              {% else %}
                const rechazado = form.querySelector('.material-rechazado')
                rechazado.value = true
                if (comentarios) {
                  comentarios.setAttribute('required', true)
                  comentarios.removeAttribute('readonly')
                  materialEliminado = true
                }
              {% endif %}

              // Las banderas de tipo "rechazado" serán true
              /*if (rechazado_compras) {
                rechazado_compras.value = true
              }
              if (rechazado_sistemas) {
                rechazado_sistemas.value = true
              }*/
            }

            fillTable()
          }
        })
      }

      const makeFieldsMandatory = () => {
        if (empresaOrigen) {
          empresaOrigen.setAttribute('required', true)
        }
        if (empresaDestino) {
          empresaDestino.setAttribute('required', true);
        }
        if (nombreProductoMigracion) {
          nombreProductoMigracion.setAttribute('required', true);
        }
        if (empresa) {
          empresa.setAttribute('required', true);
        }
        if (justificacion) {
          justificacion.setAttribute('required', true);
        }
      }

      makeFieldsMandatory()

      const makeFieldsOptional = () => {
        if (empresaOrigen) {
          empresaOrigen.removeAttribute('required')
        }
        if (empresaDestino) {
          empresaDestino.removeAttribute('required');
        }
        if (nombreProductoMigracion) {
          nombreProductoMigracion.removeAttribute('required');
        }
        if (empresa) {
          empresa.removeAttribute('required');
        }
        if (justificacion) {
          justificacion.removeAttribute('required');
        }
      }

      if (btnRemove) {
        btnRemove.addEventListener('click', () => {
          makeFieldsOptional()
        })
      }

      const disableAllFieldsForMigracion = () => {
        empresaOrigen.setAttribute('disabled', true)
        empresaDestino.setAttribute('disabled', true)
        if (comentarios) {
          comentarios.setAttribute('disabled', true)
        }
      }

      const enableAllFieldsForMigracion = () => {
        empresaOrigen.removeAttribute('disabled')
        empresaDestino.removeAttribute('disabled')
        if (comentarios) {
          comentarios.removeAttribute('disabled')
        }
      }

      function enableSaveButton() {
        if(errorEmpresaOrigen) {
          if(errorEmpresaOrigen.style.display == 'block' || errorEmpresaDestino.style.display == 'block' || errorEmpresasMigracion.style.display == 'block' || errorNombreProductoMigracion.style.display == 'block' || errorNombreProductoMigracion2.style.display == 'block') {
            if(btnSave) {
              btnSave.disabled = true
              btnRemove.disabled = true
            }
            else {
              if(btnApprove && btnDecline) {
                btnApprove.disabled = true
                btnDecline.disabled = true
              }
            }
          }
          else {
            if (btnSave) {
              btnSave.disabled = false
              btnRemove.disabled = false
            }
            else {
              if (btnApprove && btnDecline) {
                btnApprove.disabled = false
                btnDecline.disabled = false
              }
            }
          }
        }
        else {
          if (errorEmpresa.style.display == 'block' || errorJustificacion.style.display == 'block' || errorComentarios?.style.display == 'block') {
            if(btnSave) {
              btnSave.disabled = true
              btnRemove.disabled = true
            }
            else {
              if(btnApprove && btnDecline) {
                btnApprove.disabled = true
                btnDecline.disabled = true
              }
            }
          }
          else {
            if (btnSave) {
              btnSave.disabled = false
              btnRemove.disabled = false
            }
            else {
              if (btnApprove && btnDecline) {
                btnApprove.disabled = false
                btnDecline.disabled = false
              }
            }
          }
        }
      }
    });
  </script>
{% endblock %}
