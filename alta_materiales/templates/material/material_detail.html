{% extends 'base.html' %}

{% block content %}
  <main class="py-5 m-5">
    <div class="row mt-5 justify-content-center">
      <div style="max-width: 40rem;">
        <form class="card card-body" method="POST">
          <h1 class="mb-4">Detalle de la solicitud</h1>

          {{ error }}

          {% csrf_token %}

          <div style="display: none;">
            {{ solicitud_form.es_migracion.label_tag }}
            {{ solicitud_form.es_migracion }}
            <p id="error-es-migracion" style="color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
          </div>

          {% if solicitud.es_migracion %}
            <!-- Material migración fields -->
            <h2 style="margin-bottom: 2rem;">Migración - {{ solicitud.nombre_producto_migracion }}</h2>

            <div id="material-migracion-empresas" style="display: flex; gap: 1rem; margin-bottom: 1rem;">
              <!-- Empresa origen -->
              <div style="width: 100%;">
                <p class="m-0">{{ solicitud_form.empresa_origen.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                {{ solicitud_form.empresa_origen }}
                <p id="error-empresa-origen" style="color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
              </div>

              <!-- Empresa destino -->
              <div style="width: 100%;">
                <p class="m-0">{{ solicitud_form.empresa_destino.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                {{ solicitud_form.empresa_destino }}
                <p id="error-empresa-destino" style="color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
              </div>
            </div>

            <!-- Nombre producto migracion field -->
            <div style="margin-bottom:1rem;">
              <p class="m-0">{{ solicitud_form.nombre_producto_migracion.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
              {{ solicitud_form.nombre_producto_migracion }}
              <p id="error-rfc-migracion" style="color:red; margin-bottom:0; display:none;">Ingrese un RFC válido</p>
            </div>

          {% else %}

            <!-- Material nuevo fields -->
            <!-- Empresa field -->
            <div style="margin-bottom:1rem;">
              <p class="m-0">{{ solicitud_form.empresa.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
              {{ solicitud_form.empresa }}
              <p id="error-empresa" style="color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
            </div>

            <!-- Justificación field -->
            <div style="margin-bottom:1rem;">
              <p class="m-0">{{ solicitud_form.justificacion.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
              {{ solicitud_form.justificacion }}
              <p id="error-justificacion" style="color:red; margin-bottom:0; display:none;">Este campo es requerido</p>
            </div>

            <h3>Materiales</h3>

            <div id="table-materials" class="table-responsive my-3" style="font-size: 0.8rem;">
              <table class="table table-bordered table-sm">
                <thead class="text-center">
                  <tr>
                    <th scope="col">Tipo alta</th>
                    <th scope="col">Subfamilia</th>
                    <th scope="col">Nombre</th>
                    <th scope="col">Marca</th>
                    <th scope="col">Parte/Modelo</th>
                    <th scope="col">Nombre común</th>
                    <th scope="col">Medida</th>
                    <th scope="col">¿Es parte original?</th>
                    <th scope="col">Ing activo</th>
                    <th scope="col">Tipo producto</th>
                    <th scope="col">Alias</th>
                    <th scope="col">UM</th>
                    <th scope="col">¿Es material empaque?</th>
                    <th scope="col">¿Es prod terminado?</th>
                    <th scope="col"></th>
                  </tr>
                </thead>
                <tbody id="tbody-materials"></tbody>
              </table>
            </div>

            <div id="material-forms">
              {% for form in material_forms %}
                <div id="material-form-{{ forloop.counter0 }}" class="material-form" style="display:none;">
                  {{ form.as_p }}
                  <hr />
                </div>
              {% endfor %}
            </div>

          {% endif %}

          <!-- Comentarios field -->
          <div style="margin-bottom:1rem;">
            {{ solicitud_form.comentarios.label_tag }}
            {{ solicitud_form.comentarios }}
            <p id="error-comentarios" style="color:red; margin-bottom:0; display:none;">Este campo es requerido</p>
          </div>

          <div id="buttons-container" class="d-flex justify-content-between gap-2">
            {% if current_user.compras == False and current_user.finanzas == False and current_user.sistemas == False and solicitud.rechazado_compras == True or current_user.compras == False and current_user.finanzas == False and current_user.sistemas == False and solicitud.rechazado_finanzas == True or current_user.compras == False and current_user.finanzas == False and current_user.sistemas == False and solicitud.rechazado_sistemas == True %}

              {% if solicitud.es_migracion %}
                <button id="btn-save" class="btn w-100 btn-save" style="margin-top: 0.5rem; background-color: #008841; color: white; font-weight: bold;" type="submit" name="finanzas" value="True">Guardar cambios</button>
              {% else %}
                <button id="btn-save" class="btn w-100 btn-save" style="margin-top: 0.5rem; background-color: #008841; color: white; font-weight: bold;" type="submit" name="pendiente" value="True">Guardar cambios</button>
              {% endif %}

              <button id="btn-delete" class="btn btn-delete w-100" style="margin-top: 0.5rem; background-color: tomato; color: white; font-weight: bold;" type="submit" name="eliminado" value="True">Eliminar solicitud</button>
            {% endif %}

            {% if current_user.compras == True %}
              <button id="btn-approve" class="btn btn-approve w-100" style="margin-top: 0.5rem; background-color: #008841; color: white; font-weight: bold;" type="submit" name="compras" value="True">Aprobar</button>

              <button id="btn-decline" class="btn btn-reject w-100" style="margin-top: 0.5rem; background-color: tomato; color: white; font-weight: bold;" type="submit" name="rechazado_compras" value="True">Rechazar</button>
            {% endif %}

            {% if current_user.finanzas == True %}
              <button id="btn-approve" class="btn btn-approve w-100" style="margin-top: 0.5rem; background-color: #008841; color: white; font-weight: bold;" type="submit" name="finanzas" value="True">Aprobar</button>

              <button id="btn-decline" class="btn btn-reject w-100" style="margin-top: 0.5rem; background-color: tomato; color: white; font-weight: bold;" type="submit" name="rechazado_finanzas" value="True">Rechazar</button>
            {% endif %}

            {% if current_user.sistemas == True %}
              <button id="btn-approve" class="btn btn-approve w-100" style="margin-top: 0.5rem; background-color: #008841; color: white; font-weight: bold;" type="submit" name="sistemas" value="True">Aprobar</button>

              <button id="btn-decline" class="btn btn-reject w-100" style="margin-top: 0.5rem; background-color: tomato; color: white; font-weight: bold;" type="submit" name="rechazado_sistemas" value="True">Rechazar</button>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Containers
      const materialFormsContainer = document.getElementById('material-forms');
      const tableMaterials = document.getElementById('table-materials')
      const bodyMaterials = document.getElementById('tbody-materials')
      const buttonsContainer = document.getElementById('buttons-container');
      let materialCounter = 0

      // Inputs
      const empresaOrigen = document.getElementById('id_empresa_origen')
      const empresaDestino = document.getElementById('id_empresa_destino')
      const nombreProductoMigracion = document.getElementById('id_nombre_producto_migracion')
      const empresa = document.getElementById('id_empresa')
      const justificacion = document.getElementById('id_justificacion')
      const comentarios = document.getElementById('id_comentarios')
      
      // Error messages
      const errorEmpresaOrigen = document.getElementById('error-empresa-origen')
      const errorEmpresaDestino = document.getElementById('error-empresa-destino')
      const errorNombreProductoMigracion = document.getElementById('error-rfc-migracion')
      const errorEmpresa = document.getElementById('error-empresa')
      const errorJustificacion = document.getElementById('error-justificacion')
      const errorComentarios = document.getElementById('error-comentarios')
      
      // Buttons
      const btnSave = document.getElementById('btn-save')
      const btnDelete = document.getElementById('btn-delete')
      const btnApprove = document.getElementById('btn-approve')
      const btnDecline = document.getElementById('btn-decline')
      
      buttonsContainer.addEventListener('click', function(event) {  
        if (event.target && event.target.classList.contains('btn-save')) {
          comentarios.value = ''
        }
        if (event.target && event.target.classList.contains('btn-reject')) {
          comentarios.setAttribute('required', 'true')
          if(comentarios.value == '') {
            errorComentarios.style.display = 'block'
          }
        }
        if (event.target && event.target.classList.contains('btn-approve')) {
          comentarios.removeAttribute('required')
          comentarios.value = ''
        }
      });

      const disableDeleteButtons = () => {
        const deleteButtons = tableMaterials.getElementsByClassName('delete-material')
        if (materialCounter > 1) {
          for (i=0; i<deleteButtons.length; i++) {
            deleteButtons[i].removeAttribute('disabled')
          }
        }
        else {
          for (i=0; i<deleteButtons.length; i++) {
            deleteButtons[i].setAttribute('disabled', true)
          }
        }
      }

      const fillTable = () => {
        materialCounter = 0
        bodyMaterials.innerHTML = ''
        const materialForms = document.querySelectorAll('.material-form')
        materialForms.forEach(function(materialForm, index) {
          materialCounter += 1
          const tipoAlta = materialForm.querySelector('.material-tipo-alta')
          const subfamilia = materialForm.querySelector('.material-subfamilia')
          const nombre = materialForm.querySelector('.material-nombre')
          const marca = materialForm.querySelector('.material-marca')
          const parteModelo = materialForm.querySelector('.material-parte-modelo')
          const nombreComun = materialForm.querySelector('.material-nombre-comun')
          const medida = materialForm.querySelector('.material-medida')
          const esParteOriginal = materialForm.querySelector('.material-es-parte-original')
          const ingActivo = materialForm.querySelector('.material-ing-activo')
          const tipoProducto = materialForm.querySelector('.material-tipo-producto')
          const alias = materialForm.querySelector('.material-alias')
          const unidadMedida = materialForm.querySelector('.material-unidad-medida')
          const esMaterialEmpaque = materialForm.querySelector('.material-es-material-empaque')
          const esProdTerminado = materialForm.querySelector('.material-es-prod-terminado')
  
          esParteOriginalValue = esParteOriginal.checked == true ? 'Si' : 'No'
          esMaterialEmpaqueValue = esMaterialEmpaque.checked == true ? 'Si' : 'No'
          esProdTerminadoValue = esProdTerminado.checked == true ? 'Si' : 'No'
  
          const newRow = bodyMaterials.insertRow()
          newRow.classList.add('table-row')
          newRow.id = `table-row-${index}`
          newRow.innerHTML = `
          <td>${tipoAlta.value}</td>
          <td>${subfamilia.value}</td>
          <td>${nombre.value}</td>
          <td>${marca.value}</td>
          <td>${parteModelo.value}</td>
          <td>${nombreComun.value}</td>
          <td>${medida.value}</td>
          <td>${esParteOriginalValue}</td>
          <td>${ingActivo.value}</td>
          <td>${tipoProducto.value}</td>
          <td>${alias.value}</td>
          <td>${unidadMedida.value}</td>
          <td>${esMaterialEmpaqueValue}</td>
          <td>${esProdTerminadoValue}</td>
          <td>
            <button id="edit-material-${index}" class="btn btn-primary edit-material" type="button" style="font-size:0.8rem">Editar</button>
          </td>
          <td>
            <button id="delete-material-${index}" class="btn btn-danger delete-material" type="button" style="font-size:0.8rem">Eliminar</button>
          </td>`
        })

        disableDeleteButtons()
      }

      if (tableMaterials) {
        fillTable()

        tableMaterials.addEventListener('click', function(event) {
          // Edit material
          if (event.target && event.target.classList.contains('edit-material')) {
            // Fill the table with the updated data
            fillTable()
            // Disable edit button
            const editButtons = tableMaterials.getElementsByClassName('edit-material');
            for (let i = 0; i < editButtons.length; i++) {
              editButtons[i].disabled = false
            }
            event.target.disabled = true
            // Show the selected form
            const forms = document.getElementsByClassName('material-form');
            for (let i = 0; i < forms.length; i++) {
              forms[i].style.display = 'none'
            }
            editingId = event.target.id.substring(14, event.target.id.length)
            const form = document.getElementById(`material-form-${editingId}`)
            if (form) {
              form.style.display = "block"
            }
          }
          // Delete material
          if (event.target && event.target.classList.contains('delete-material')) {
            deleteId = event.target.id.substring(16, event.target.id.length)
            const form = document.getElementById(`material-form-${deleteId}`)
            if (form) {
              form.remove()
              // Recorre todos los formularios restantes y actualiza sus índices
              const forms = materialFormsContainer.getElementsByClassName('material-form');
              for (let i = 0; i < forms.length; i++) {
                forms[i].id = `material-form-${i}`
                const inputs = forms[i].querySelectorAll('[id^=id_material-]');
                for (let j = 0; j < inputs.length; j++) {
                  inputs[j].id = inputs[j].id.replace(/\d+/, i);
                }
              }
            }
            fillTable()
          }
        })
      }

      // FIELD VALIDATION

      // Validacion empresa origen
      if (empresaOrigen) {
        empresaOrigen.addEventListener('change', () => {
          if (empresaOrigen.value == '') {
            errorEmpresaOrigen.style.display = 'block'
          } else {
            errorEmpresaOrigen.style.display = 'none'
          }
          enableSaveButton()
        })
      }
      
      // Validacion empresa destino
      if (empresaDestino) {
        empresaDestino.addEventListener('change', () => {
          if (empresaDestino.value == '') {
            errorEmpresaDestino.style.display = 'block'
          } else {
            errorEmpresaDestino.style.display = 'none'
          }
          enableSaveButton()
        })
      }
      
      // Validacion rfc migracion
      if (nombreProductoMigracion) {
        nombreProductoMigracion.addEventListener('input', () => {
          if (rfcPattern.test(nombreProductoMigracion.value)) {
            errorNombreProductoMigracion.style.display = 'none'
          } else {
            errorNombreProductoMigracion.style.display = 'block'
          }
          enableSaveButton()
        })
      }
    
      // Validacion empresa
      if (empresa) {
        empresa.addEventListener('change', () => {asd
          if (empresa.value == '') {
            errorEmpresa.style.display = 'block'
          } else {
            errorEmpresa.style.display = 'none'
          }
          enableSaveButton()
        })
      }
      
      // Validacion justificacion
      if (justificacion) {
        justificacion.addEventListener('input', () => {
          if (justificacion.value == '') {
            errorJustificacion.style.display = 'block'
          } else {
            errorJustificacion.style.display = 'none'
          }
          enableSaveButton()
        })
      }
      
      // Validacion comentarios
      comentarios.addEventListener('input', () => {
        if (comentarios.value == '') {
          errorComentarios.style.display = 'block'
        } else {
          errorComentarios.style.display = 'none'
        }
        enableSaveButton()
      })

      function enableSaveButton() {
        if(errorEmpresa.style.display == 'block' || errorJustificacion.style.display == 'block' || errorComentarios.style.display == 'block') {
          if(btnSave) {
            btnSave.disabled = true
            btnDelete.disabled = true
          }
          else {
            if(btnApprove && btnDecline) {
              btnApprove.disabled = true
              btnDecline.disabled = true
            }
          }
        }
        else {
          if (btnSave) {
            btnSave.disabled = false
            btnDelete.disabled = false
          }
          else {
            if (btnApprove && btnDecline) {
              btnApprove.disabled = false
              btnDecline.disabled = false
            }
          }
        }
      }
    });
  </script>
{% endblock %}
