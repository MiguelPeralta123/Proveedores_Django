{% extends 'base.html' %}

{% block content %}
  <main class="pt-5 m-5">
    <div class="row mt-5 justify-content-center">
      <div style="max-width: 40rem;">
        <form class="card card-body" method="POST" style="background-color: rgb(255, 255, 255, 0.8);">
          <h1 class="mb-4">Detalle de la solicitud</h1>

          {{ error }}

          {% csrf_token %}

          <div style="display: none;">
            {{ solicitud_form.es_migracion.label_tag }}
            {{ solicitud_form.es_migracion }}
            <p id="error-es-migracion" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
          </div>

          {% if solicitud.es_migracion %}

            <!-- Material migración fields -->
            <h2 style="margin-bottom: 2rem;">Migración - {{ solicitud.nombre_producto_migracion }}</h2>

            <div id="material-migracion-empresas" style="display: flex; gap: 1rem;">
              <!-- Empresa origen -->
              <div style="width: 100%;">
                <p class="m-0">{{ solicitud_form.empresa_origen.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                {{ solicitud_form.empresa_origen }}
                <p id="error-empresa-origen" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
              </div>

              <!-- Empresa destino -->
              <div style="width: 100%;">
                <p class="m-0">{{ solicitud_form.empresa_destino.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                {{ solicitud_form.empresa_destino }}
                <p id="error-empresa-destino" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
              </div>
            </div>

            <p id="error-empresas-migracion" class="mt-0 mb-2" style="color:red; display:none;">Empresa origen y Empresa destino deben tener valores distintos</p>

            <!-- Nombre producto migracion field -->
            <div class="mt-3 mb-3">
              <label for="id_nombre_producto_migracion">Nombre producto:<span style="color: rgb(192, 0, 0);">*</span></label>
              {{ solicitud_form.nombre_producto_migracion }}
              <datalist id="opciones_material">
              </datalist>
              <p id="error-nombre-producto-migracion" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Ingrese un nombre de producto válido</p>
              <p id="error-nombre-producto-migracion-2" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">No existe ningún producto con ese nombre</p>
            </div>

          {% else %}

            <!-- Material nuevo fields -->
            <!-- Empresa field -->
            <div style="margin-bottom:1rem;">
              <p class="m-0">{{ solicitud_form.empresa.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
              {{ solicitud_form.empresa }}
              <p id="error-empresa" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
            </div>

            <!-- Justificación field -->
            <div style="margin-bottom:1rem;">
              <label for="id_justificacion">Justificación:<span style="color: rgb(192, 0, 0);">*</span></label>
              {{ solicitud_form.justificacion }}
              <p id="error-justificacion" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es requerido</p>
            </div>

            <h3>Materiales</h3>

            <div id="table-materials" class="table-responsive my-3" style="font-size: 0.8rem; background-color: rgb(255, 255, 255);">
              <table class="table table-bordered table-sm">
                <thead class="text-center">
                  <tr>
                    <th scope="col" style="min-width: 6rem;">Tipo alta</th>
                    <th scope="col" style="min-width: 6rem;">Subfamilia</th>
                    <th scope="col" style="min-width: 6rem;">Nombre</th>
                    <th scope="col" style="min-width: 6rem;">Foto del producto</th>
                    <th scope="col" style="min-width: 6rem;">Largo</th>
                    <th scope="col" style="min-width: 6rem;">Ancho</th>
                    <th scope="col" style="min-width: 6rem;">Alto</th>
                    <th scope="col" style="min-width: 6rem;">Calibre</th>
                    <th scope="col" style="min-width: 6rem;">Material</th>
                    <th scope="col" style="min-width: 6rem;">Color</th>
                    <th scope="col" style="min-width: 6rem;">Marca</th>
                    <th scope="col" style="min-width: 6rem;">Parte / Modelo</th>
                    <th scope="col" style="min-width: 6rem;">Nombre común</th>
                    <th scope="col" style="min-width: 6rem;">Ing. activo</th>
                    <th scope="col" style="min-width: 6rem;">Porcentaje IVA</th>
                    <th scope="col" style="min-width: 6rem;">Alias</th>
                    <th scope="col" style="min-width: 6rem;">Unidad de medida</th>
                    <th scope="col" style="min-width: 6rem;">Código SAT</th>
                    <th scope="col" style="min-width: 6rem;">¿Es mezcla?</th>
                    <th scope="col" style="min-width: 6rem;">¿Es material empaque?</th>
                    <th scope="col" style="min-width: 6rem;">¿Es prod. terminado?</th>
                    <th scope="col" style="min-width: 4rem;"></th>
                    <th scope="col" style="min-width: 4rem;"></th>
                  </tr>
                </thead>
                <tbody id="tbody-materials"></tbody>
              </table>
            </div>

            <div id="material-forms">
              {% for form in material_forms %}
                <div id="material-form-{{ forloop.counter0 }}" class="material-form" style="display:none;">
                  
                  <!-- Tipo alta field -->
                  <div class="tipo-alta-container" style="margin-bottom:1rem;">
                    <p class="m-0">{{ form.tipo_alta.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                    {{ form.tipo_alta }}
                    <p id="error-tipo-alta" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                  </div>

                  <!-- Subfamilia field -->
                  <div class="subfamilia-container" style="margin-bottom:1rem;">
                    <p class="m-0">{{ form.subfamilia.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                    {{ form.subfamilia }}
                    <p id="error-subfamilia" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                  </div>

                  <!-- Nombre producto field -->
                  <div class="nombre-producto-container" style="margin-bottom:1rem;">
                    <p class="m-0">{{ form.nombre_producto.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                    {{ form.nombre_producto }}
                    <datalist id="opciones_material">
                    </datalist>
                    <p id="error-nombre-producto" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    <p id="error-nombre-producto-2" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Ya existe un producto con ese nombre</p>
                  </div>

                  <!-- Documentos -->
                  <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">

                    <!-- Foto producto field -->
                    <div class="foto-producto-container" style="width: 50%;">
                      <!-- Preview de la foto del producto -->
                      <img id="id_foto_producto_img" class="w-auto mb-2 rounded" src="/{{ form.foto_producto.value }}" alt="Foto del producto" style="max-width: 100%; max-height: 10rem;" />

                      <!-- Enlace para descargar la foto del producto -->
                      {% if form.foto_producto.value %}
                        <a id="id_foto_producto_download" href="/{{ form.foto_producto.value }}" class="mb-2" style="width:fit-content; display: block;" download="">Descargar foto del producto</a>
                      {% endif %}

                      <label for="id_foto_producto" class="mb-2" style="display: block;"><span id="foto-producto-label">Foto del producto: <span style="font-size: 0.8rem; font-style: italic;">(solo se aceptan imágenes)</span></span></label>
                      {{ form.foto_producto }}
                      <p id="error-foto-producto" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                    </div>
  
                    <!-- Ficha técnica field -->
                    <div class="ficha-tecnica-container" style="width: 50%;">
                      <!-- Preview de la ficha técnica -->
                      <img id="id_ficha_tecnica_img" class="w-auto mb-2 rounded" src="/{{ form.ficha_tecnica.value }}" alt="Ficha técnica" style="max-width: 100%; max-height: 10rem;" />

                      <!-- Enlace para descargar la ficha técnica -->
                      {% if form.ficha_tecnica.value %}
                        <a id="id_ficha_tecnica_download" href="/{{ form.ficha_tecnica.value }}" class="mb-2" style="width:fit-content; display: block;" download="">Descargar ficha técnica</a>
                      {% endif %}

                      <label for="id_ficha_tecnica" class="mb-2" style="display: block;"><span id="ficha-tecnica-label">Ficha técnica:</span></label>
                      {{ form.ficha_tecnica }}
                      <p id="error-ficha-tecnica" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                    </div>

                  </div>

                  <div id="medidas-container">
                    <p class="m-0">Medidas <span style="font-size: 0.8rem; font-style: italic;">(El valor debe ser numérico, fracción o N/A)</span></p>
                    
                    <div style="display: flex; gap: 1rem;">
                      <!-- Largo field -->
                      <div class="largo-container" style="width: 25%; margin-bottom:1rem;">
                        <p class="m-0">{{ form.largo.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                        {{ form.largo }}
                        <p id="error-largo" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">El valor debe ser numérico, fracción o N/A</p>
                        {% if form.largo.value == 'N/A' %}
                          <p id="label-largo" style="margin-bottom:0; margin-left: 0.2rem; font-size: 0.8rem; font-style: italic; color: 'gray';">No aplica</p>
                        {% else %}
                          <p id="label-largo" style="margin-bottom:0; margin-left: 0.2rem; font-size: 0.8rem; font-style: italic; color: 'gray';">{{ form.um_largo.value }}</p>
                        {% endif %}
                      </div>
  
                      <!-- Ancho field -->
                      <div class="ancho-container" style="width: 25%; margin-bottom:1rem;">
                        <p class="m-0">{{ form.ancho.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                        {{ form.ancho }}
                        <p id="error-ancho" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">El valor debe ser numérico, fracción o N/A</p>
                        {% if form.ancho.value == 'N/A' %}
                          <p id="label-ancho" style="margin-bottom:0; margin-left: 0.2rem; font-size: 0.8rem; font-style: italic; color: 'gray';">No aplica</p>
                        {% else %}
                          <p id="label-ancho" style="margin-bottom:0; margin-left: 0.2rem; font-size: 0.8rem; font-style: italic; color: 'gray';">{{ form.um_ancho.value }}</p>
                        {% endif %}
                      </div>
  
                      <!-- Alto field -->
                      <div class="alto-container" style="width: 25%; margin-bottom:1rem;">
                        <p class="m-0">{{ form.alto.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                        {{ form.alto }}
                        <p id="error-alto" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">El valor debe ser numérico, fracción o N/A</p>
                        {% if form.alto.value == 'N/A' %}
                          <p id="label-alto" style="margin-bottom:0; margin-left: 0.2rem; font-size: 0.8rem; font-style: italic; color: 'gray';">No aplica</p>
                        {% else %}
                          <p id="label-alto" style="margin-bottom:0; margin-left: 0.2rem; font-size: 0.8rem; font-style: italic; color: 'gray';">{{ form.um_alto.value }}</p>
                        {% endif %}
                      </div>
  
                      <!-- Calibre field -->
                      <div class="calibre-container" style="width: 25%; margin-bottom:1rem;">
                        <p class="m-0">{{ form.calibre.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                        {{ form.calibre }}
                        <p id="error-calibre" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">El valor debe ser numérico, fracción o N/A</p>
                        {% if form.calibre.value == 'N/A' %}
                          <p id="label-calibre" style="margin-bottom:0; margin-left: 0.2rem; font-size: 0.8rem; font-style: italic; color: 'gray';">No aplica</p>
                        {% else %}
                          <p id="label-calibre" style="margin-bottom:0; margin-left: 0.2rem; font-size: 0.8rem; font-style: italic; color: 'gray';">{{ form.um_calibre.value }}</p>
                        {% endif %}
                      </div>
                    </div>

                    <div id="id-unidades-medida" class="d-flex justify-content-between gap-3">
                      <div>
                        <label for="id-medidas-iguales">Todas las medidas tienen la misma unidad:</label>
                        <input type="checkbox" id="id-medidas-iguales" class="medidas-iguales">
                      </div>
  
                      <div class="mb-1" style="width: 12rem;">
                        <!-- UM Largo field -->
                        <div id="select-largo">
                          {{ form.um_largo }}
                          <p id="error-largo" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                        </div>
                        <!-- UM Ancho field -->
                        <div id="select-ancho" style="display: none;">
                          {{ form.um_ancho }}
                          <p id="error-ancho" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                        </div>
                        <!-- UM Alto field -->
                        <div id="select-alto" style="display: none;">
                          {{ form.um_alto }}
                          <p id="error-alto" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                        </div>
                        <!-- UM Calibre field -->
                        <div id="select-calibre" style="display: none;">
                          {{ form.um_calibre }}
                          <p id="error-calibre" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                        </div>

                        <p id="error-unidades-medida" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una unidad para cada medida</p>
                      </div>
                    </div>
                  </div>

                  <div style="display: flex; gap: 1rem;">
                    <!-- Material field -->
                    <div class="material-container" style="width: 50%; margin-bottom:1rem;">
                      <p class="m-0">{{ form.material.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                      {{ form.material }}
                      <p id="error-material" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>

                    <!-- Color field -->
                    <div class="color-container" style="width: 50%; margin-bottom:1rem;">
                      <p class="m-0">{{ form.color.label_tag }}<span style="color: rgb(192, 0, 0);">*</span></p>
                      {{ form.color }}
                      <p id="error-color" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>
                  </div>

                  <div style="display: flex; gap: 1rem;">
                    <!-- Marca field -->
                    <div style="width: 50%; margin-bottom:1rem;">
                      {{ form.marca.label_tag }}
                      {{ form.marca }}
                      <p id="error-marca" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>

                    <!-- Parte / Modelo field -->
                    <div style="width: 50%; margin-bottom:1rem;">
                      <label for="id_parte_modelo">Parte / Modelo:</label>
                      {{ form.parte_modelo }}
                      <p id="error-parte-modelo" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>
                  </div>

                  <div style="display: flex; gap: 1rem;">
                    <!-- Nombre común field -->
                    <div style="width: 50%; margin-bottom:1rem;">
                      <label for="id_nombre_comun">Nombre común:</label>
                      {{ form.nombre_comun }}
                      <p id="error-nombre-comun" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>

                    <!-- Ing activo field -->
                    <div style="width: 50%; margin-bottom:1rem;">
                      <label for="id_ing_activo">Ingrediente activo:</label>
                      {{ form.ing_activo }}
                      <p id="error-ing-activo" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>
                  </div>

                  <div style="display: flex; gap: 1rem;">
                    <!-- Porcentaje IVA field -->
                    <div style="width: 50%; margin-bottom:1rem;">
                      <label for="id_porcentaje_iva">% de IVA:</label>
                      {{ form.porcentaje_iva }}
                      <p id="error-porcentaje-iva" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>

                    <!-- Alias field -->
                    <div style="width: 50%; margin-bottom:1rem;">
                      {{ form.alias.label_tag }}
                      {{ form.alias }}
                      <p id="error-alias" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>
                  </div>

                  <div style="display: flex; gap: 1rem;">
                    <!-- Unidad de medida field -->
                    <div class="unidad-medida-container" style="width: 50%; margin-bottom:1rem;">
                      <label for="id_unidad_medida">Unidad de medida:<span style="color: rgb(192, 0, 0);">*</span></label>
                      {{ form.unidad_medida }}
                      <p id="error-unidad-medida" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Seleccione una opción válida</p>
                    </div>

                    <!-- Código sat field -->
                    <div style="width: 50%; margin-bottom:1rem;">
                      <label for="id_codigo_sat">Código SAT:</label>
                      {{ form.codigo_sat }}
                      <p id="error-codigo-sat" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>
                  </div>

                  <div style="display: flex; justify-content: space-between; gap: 2rem;">
                    <!-- Es mezcla field -->
                    <div style="margin-bottom:1rem;">
                      <label for="id_es_mezcla">¿Es mezcla?</label>
                      {{ form.es_mezcla }}
                      <p id="error-es-mezcla" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>

                    <!-- Es material empaque field -->
                    <div style="margin-bottom:1rem;">
                      <label for="id_es_material_empaque">¿Es material empaque?</label>
                      {{ form.es_material_empaque }}
                      <p id="error-es-material-empaque" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>

                    <!-- Es prod terminado field -->
                    <div style="margin-bottom:1rem;">
                      <label for="id_es_prod_terminado">¿Es prod. terminado?</label>
                      {{ form.es_prod_terminado }}
                      <p id="error-es-prod-terminado" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es obligatorio</p>
                    </div>
                  </div>

                  <!-- Esta bandera será false. Si el material se elimina, entonces se marcará como true -->
                  {{ form.rechazado }}

                  <button class="btn btn-secondary mt-3 mb-3 btn-save-changes" type="button" style="background-color: #008841; color: white; font-weight: bold;">Guardar cambios</button>
                </div>
              {% endfor %}
            </div>

          {% endif %}

          <!-- Comentarios field -->
          {% if solicitud.pendiente and current_user.compras or solicitud.compras and current_user.finanzas or solicitud.finanzas and current_user.sistemas or solicitud.comentarios != '' %}
            <div style="margin-bottom:1rem;">
              {{ solicitud_form.comentarios.label_tag }}
              {{ solicitud_form.comentarios }}
              <p id="error-comentarios" style="font-size: 0.9rem; color:red; margin-bottom:0; display:none;">Este campo es requerido</p>
            </div>
          {% endif %}

          <div id="buttons-container" class="d-flex justify-content-between gap-2">
            {% if current_user.id == solicitud.usuario.id and solicitud.rechazado_compras or solicitud.rechazado_finanzas or solicitud.rechazado_sistemas or solicitud.borrador %}

              {% if solicitud.es_migracion %}
                <button id="btn-save" class="btn w-100 btn-save btn-rechazado-false" style="margin-top: 0.5rem; background-color: #008841; color: white; font-weight: bold;" type="submit" name="finanzas" value="True">Enviar</button>
              {% else %}
                <button id="btn-save" class="btn w-100 btn-save btn-rechazado-false" style="margin-top: 0.5rem; background-color: #008841; color: white; font-weight: bold;" type="submit" name="pendiente" value="True">Enviar</button>
              {% endif %}

              <button id="btn-remove" class="btn btn-remove w-100" style="margin-top: 0.5rem; background-color: tomato; color: white; font-weight: bold;" type="submit" name="eliminado" value="True">Eliminar solicitud</button>

            {% else %}

              {% if solicitud.pendiente == True and current_user.compras == True and solicitud.borrador == False %}
                <!--{{ solicitud_form.rechazado_compras }}-->
                <button id="btn-approve" class="btn btn-approve w-100" style="margin-top: 0.5rem; background-color: #008841; color: white; font-weight: bold;" type="submit" name="finanzas" value="True">Aprobar</button>
                <button id="btn-decline" class="btn btn-reject w-100" style="margin-top: 0.5rem; background-color: tomato; color: white; font-weight: bold;" type="submit" name="rechazado_compras" value="True">Rechazar</button>
              {% endif %}

              {% if solicitud.finanzas and current_user.sistemas and not solicitud.borrador %}
                <!--{{ solicitud_form.rechazado_sistemas }}-->
                <button id="btn-approve" class="btn btn-approve w-100" style="margin-top: 0.5rem; background-color: #008841; color: white; font-weight: bold;" type="submit" name="sistemas" value="True">Aprobar</button>
                <button id="btn-decline" class="btn btn-reject w-100" style="margin-top: 0.5rem; background-color: tomato; color: white; font-weight: bold;" type="submit" name="rechazado_sistemas" value="True">Rechazar</button>
              {% endif %}

            {% endif %}
          </div>
        </form>

        <button id="btn-back" class="btn btn-secondary">Volver</button>
      </div>
    </div>
  </main>

  <style>
      .table-row-hidden {
          display: none;
      }
      #btn-back {
          width: 10rem;
          margin-top: 2rem;
          font-weight: bold;
          background-color: rgb(0, 128, 0, 0.6);
          transition: 0.2s ease-in-out;
      }
      #btn-back:hover {
          scale: 1.05;
          background-color: rgb(0, 128, 0);
      }
      .material-foto-producto,
      .material-ficha-tecnica {
        width: 100%;
      }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Containers
      const materialFormsContainer = document.getElementById('material-forms');
      const tableMaterials = document.getElementById('table-materials')
      const bodyMaterials = document.getElementById('tbody-materials')
      const buttonsContainer = document.getElementById('buttons-container');
      const datalist = document.getElementById("opciones_material")

      // Inputs
      const empresaOrigen = document.getElementById('id_empresa_origen')
      const empresaDestino = document.getElementById('id_empresa_destino')
      const nombreProductoMigracion = document.getElementById('id_nombre_producto_migracion')
      const empresa = document.getElementById('id_empresa')
      const justificacion = document.getElementById('id_justificacion')
      const comentarios = document.getElementById('id_comentarios')
      //const rechazado_compras = document.getElementById('id_rechazado_compras')
      //const rechazado_sistemas = document.getElementById('id_rechazado_sistemas')
      
      // Error messages
      const errorEmpresaOrigen = document.getElementById('error-empresa-origen')
      const errorEmpresaDestino = document.getElementById('error-empresa-destino')
      const errorEmpresasMigracion = document.getElementById('error-empresas-migracion')
      const errorNombreProductoMigracion = document.getElementById('error-nombre-producto-migracion')
      const errorNombreProductoMigracion2 = document.getElementById('error-nombre-producto-migracion-2')
      const errorEmpresa = document.getElementById('error-empresa')
      const errorJustificacion = document.getElementById('error-justificacion')
      const errorComentarios = document.getElementById('error-comentarios')
      
      // Buttons
      const btnSave = document.getElementById('btn-save')
      const btnRemove = document.getElementById('btn-remove')
      const btnApprove = document.getElementById('btn-approve')
      const btnDecline = document.getElementById('btn-decline')
      const btnBack = document.getElementById('btn-back')
      const btnsRechazadoFalse = document.querySelectorAll('.btn-rechazado-false')
      
      // Regular expressions
      const fraccionPattern = /^(\d+(\.\d+)?\/\d+(\.\d+)?)$/;

      // Counters and bands
      let materialCounter = 0
      let medidasIguales = false
      let materialEliminado = false

      // Catalogo de materiales existentes
      var catalogoMaterial = {{ catalogo_material|safe }}
      if (nombreProductoMigracion) {
        nombreProductoMigracion.setAttribute('list', 'opciones_material')
      }

      btnBack.addEventListener('click', () => {
        window.history.back()
      })

      if (btnsRechazadoFalse) {
        btnsRechazadoFalse.forEach(btnRechazadoFalse => {
          btnRechazadoFalse.addEventListener('click', () => {
            const rechazadoBands = document.querySelectorAll('.material-rechazado')
            rechazadoBands.forEach(rechazadoBand => {
              rechazadoBand.value = false
            })
          })
        })
      }

      if (materialFormsContainer) {
        materialFormsContainer.addEventListener('click', event => {
          // Si se hace clic en "Guardar cambios", ocultar el formulario y actualizar la tabla
          if (event.target && event.target.classList.contains('btn-save-changes')) {
            const form = event.target.closest('.material-form')
            errorTipoAlta = form.querySelector('#error-tipo-alta')
            errorSubfamilia = form.querySelector('#error-subfamilia')
            errorNombreProducto = form.querySelector('#error-nombre-producto')
            errorNombreProducto2 = form.querySelector('#error-nombre-producto-2')
            errorLargo = form.querySelector('#error-largo')
            errorAncho = form.querySelector('#error-ancho')
            errorAlto = form.querySelector('#error-alto')
            errorCalibre = form.querySelector('#error-calibre')
            errorUnidadesMedida = form.querySelector('#error-unidades-medida')
            errorMaterial = form.querySelector('#error-material')
            errorColor = form.querySelector('#error-color')
            errorUnidadMedida = form.querySelector('#error-unidad-medida')

            const largo = form.querySelector('.material-largo')
            const ancho = form.querySelector('.material-ancho')
            const alto = form.querySelector('.material-alto')
            const calibre = form.querySelector('.material-calibre')
            const umLargo = form.querySelector('.select-um-largo')
            const umAncho = form.querySelector('.select-um-ancho')
            const umAlto = form.querySelector('.select-um-alto')
            const umCalibre = form.querySelector('.select-um-calibre')

            if (largo.value != 'N/A' && umLargo.value == '') {
              errorUnidadesMedida.style.display = 'block'
              window.alert('Debe seleccionar una unidad para "Largo"')
              return
            }
            if (ancho.value != 'N/A' && umAncho.value == '') {
              errorUnidadesMedida.style.display = 'block'
              window.alert('Debe seleccionar una unidad para "Ancho"')
              return
            }
            if (alto.value != 'N/A' && umAlto.value == '') {
              errorUnidadesMedida.style.display = 'block'
              window.alert('Debe seleccionar una unidad para "Alto"')
              return
            }
            if (calibre.value != 'N/A' && umCalibre.value == '') {
              errorUnidadesMedida.style.display = 'block'
              window.alert('Debe seleccionar una unidad para "Calibre"')
              return
            }

            errorUnidadesMedida.style.display = 'none'
            if (largo.value == 'N/A') {
              umLargo.value = ''
            }
            if (ancho.value == 'N/A') {
              umAncho.value = ''
            }
            if (alto.value == 'N/A') {
              umAlto.value = ''
            }
            if (calibre.value == 'N/A') {
              umCalibre.value = ''
            }
  
            if (errorTipoAlta.style.display == 'block' || errorSubfamilia.style.display == 'block' || errorNombreProducto.style.display == 'block' || errorNombreProducto2.style.display == 'block' || errorLargo.style.display == 'block' || errorAncho.style.display == 'block' || errorAlto.style.display == 'block' || errorCalibre.style.display == 'block' || errorUnidadesMedida.style.display == 'block' || errorMaterial.style.display == 'block' || errorColor.style.display == 'block' || errorUnidadMedida.style.display == 'block') {
              window.alert('Algún campo está vacío o es incorrecto')
            }
            else {
              const forms = materialFormsContainer.querySelectorAll('.material-form');
              forms.forEach(form => {
                form.style.display = 'none'
              })
              const editButtons = tableMaterials.querySelectorAll('.edit-material');
              editButtons.forEach(editButton => {
                editButton.removeAttribute('disabled')
              })
              fillTable()

              // Habilitar botones de tipo submit
              if (btnSave) {
                btnSave.removeAttribute('disabled')
                btnRemove.removeAttribute('disabled')
              }
              if (btnApprove) {
                btnApprove.removeAttribute('disabled')
                btnDecline.removeAttribute('disabled')
              }
            }
          }
        })
      }
      
      buttonsContainer.addEventListener('click', function(event) {  
        if (event.target && event.target.classList.contains('btn-save')) {
          comentarios.value = ''
        }
        if (event.target && event.target.classList.contains('btn-reject')) {
          comentarios.setAttribute('required', 'true')
          if(comentarios.value == '') {
            errorComentarios.style.display = 'block'
          }
        }
        if (event.target && event.target.classList.contains('btn-approve')) {
          if (!materialEliminado) {
            comentarios.removeAttribute('required')
            comentarios.value = ''
          }
        }
      });

      const disableRemoveButtons = () => {
        const removeButtons = tableMaterials.getElementsByClassName('remove-material')
        if (materialCounter > 1) {
          for (i=0; i<removeButtons.length; i++) {
            removeButtons[i].removeAttribute('disabled')
          }
        }
        else {
          for (i=0; i<removeButtons.length; i++) {
            removeButtons[i].setAttribute('disabled', true)
          }
        }
      }

      // VALIDACIÓN DE CAMPOS
      
      // Validación empresa origen
      if (empresaOrigen) {
        const validateEmpresaOrigen = () => {
          if (empresaOrigen.value == '') {
            errorEmpresaOrigen.style.display = 'block'
            errorEmpresasMigracion.style.display = 'none'
          } else {
            errorEmpresaOrigen.style.display = 'none'
            // No se puede seleccionar la misma opción que en "Empresa origen"
            if (empresaOrigen.value == empresaDestino.value) {
              errorEmpresasMigracion.style.display = 'block'
            } else {
              errorEmpresasMigracion.style.display = 'none'
            }
          }
          enableSaveButton()
        }
        empresaOrigen.addEventListener('focus', validateEmpresaOrigen)
        empresaOrigen.addEventListener('change', validateEmpresaOrigen)
      }
      
      // Validación empresa destino
      if (empresaDestino) {
        const validateEmpresaDestino = () => {
          if (empresaDestino.value == '') {
            errorEmpresaDestino.style.display = 'block'
            errorEmpresasMigracion.style.display = 'none'
          } else {
            errorEmpresaDestino.style.display = 'none'
            // No se puede seleccionar la misma opción que en "Empresa origen"
            if (empresaOrigen.value == empresaDestino.value) {
              errorEmpresasMigracion.style.display = 'block'
            } else {
              errorEmpresasMigracion.style.display = 'none'
            }
          }
          enableSaveButton()
        }
        empresaDestino.addEventListener('focus', validateEmpresaDestino)
        empresaDestino.addEventListener('change', validateEmpresaDestino)
      }
      
      // Validación nombre producto migracion
      if (nombreProductoMigracion) {
        const validateNombreProductoMigracion = () => {
          if (nombreProductoMigracion.value != '') {
            errorNombreProductoMigracion.style.display = 'none'
          } else {
            errorNombreProductoMigracion.style.display = 'block'
          }

          // Filtrando las opciones del catálogo que empiecen con el valor de nombre producto
          datalist.innerHTML = ''
          for (var i = 0; i < catalogoMaterial.length; i++) {
            if (catalogoMaterial[i].value.toUpperCase().startsWith(nombreProductoMigracion.value.toUpperCase())) {
              const option = document.createElement('option')
              option.value = catalogoMaterial[i].value
              option.innerText = catalogoMaterial[i].text
              datalist.appendChild(option)
            }
            if (datalist.childElementCount == 0) {
              errorNombreProductoMigracion2.style.display = 'block'
              disableAllFieldsForMigracion()
            } else {
              errorNombreProductoMigracion2.style.display = 'none'
              enableAllFieldsForMigracion()
            }
          }
          enableSaveButton()
        }
        nombreProductoMigracion.addEventListener('focus', validateNombreProductoMigracion)
        nombreProductoMigracion.addEventListener('input', validateNombreProductoMigracion)

        const validateNombreProductoMigracionOnChange = () => {
          let showError = true
          for (var i = 0; i < catalogoMaterial.length; i++) {
            if (catalogoMaterial[i].value.toUpperCase() == nombreProductoMigracion.value.toUpperCase()) {
              showError = false
              break
            }
          }
          if (showError) {
            errorNombreProductoMigracion2.style.display = 'block'
            disableAllFieldsForMigracion()
          } else {
            errorNombreProductoMigracion2.style.display = 'none'
            enableAllFieldsForMigracion()
          }
          enableSaveButton()
        }
        nombreProductoMigracion.addEventListener('change', validateNombreProductoMigracionOnChange)
      }
    
      // Validación empresa
      if (empresa) {
        const validateEmpresa = () => {
          if (empresa.value == '') {
            errorEmpresa.style.display = 'block'
          } else {
            errorEmpresa.style.display = 'none'
          }
          enableSaveButton()
        }
        empresa.addEventListener('focus', validateEmpresa)
        empresa.addEventListener('change', validateEmpresa)
      }
      
      // Validación justificacion
      if (justificacion) {
        const validateJustificacion = () => {
          if (justificacion.value == '') {
            errorJustificacion.style.display = 'block'
          } else {
            errorJustificacion.style.display = 'none'
          }
          enableSaveButton()
        }
        justificacion.addEventListener('focus', validateJustificacion)
        justificacion.addEventListener('input', validateJustificacion)
      }

      const validarCamposMaterial = () => {

        // Validación tipo alta
        var tipoAltaInputs = document.querySelectorAll('.material-tipo-alta')
        tipoAltaInputs.forEach(input => {
            const validateTipoAlta = () => {
                var tipoAltaValue = input.value
                var container = input.closest('.tipo-alta-container')
                var errorTipoAlta = container.querySelector('#error-tipo-alta')
                // Verificar si el campo está vacío
                if (tipoAltaValue == '') {
                  errorTipoAlta.style.display = 'block'
                } else {
                  errorTipoAlta.style.display = 'none'
                }
            }
            input.addEventListener('focus', validateTipoAlta)
            input.addEventListener('change', validateTipoAlta)
        })

        // Validación subfamilia
        var subfamiliaInputs = document.querySelectorAll('.material-subfamilia')
        subfamiliaInputs.forEach(input => {
            const validateSubfamilia = () => {
                var subfamiliaValue = input.value
                var container = input.closest('.subfamilia-container')
                var errorSubfamilia = container.querySelector('#error-subfamilia')
                // Verificar si el campo está vacío
                if (subfamiliaValue == '') {
                  errorSubfamilia.style.display = 'block'
                } else {
                  errorSubfamilia.style.display = 'none'
                }
            }
            input.addEventListener('focus', validateSubfamilia)
            input.addEventListener('change', validateSubfamilia)
        })

        // Validación nombre producto
        var nombreProductoInputs = document.querySelectorAll('.material-nombre')
        nombreProductoInputs.forEach(input => {
            input.setAttribute('list', 'opciones_material')
            const validateNombreProducto = () => {
                var nombreProductoValue = input.value
                var container = input.closest('.nombre-producto-container')
                var errorNombreProducto = container.querySelector('#error-nombre-producto')
                // Verificar si el campo está vacío
                if (nombreProductoValue == '') {
                  errorNombreProducto.style.display = 'block'
                } else {
                  errorNombreProducto.style.display = 'none'
                }
            }
            input.addEventListener('focus', validateNombreProducto)
            input.addEventListener('input', () => {
              validateNombreProducto()
              // Filtrando las opciones del catálogo que empiecen con el valor de nombre producto
              const nombreProductoContainer = input.closest('.nombre-producto-container')
              const errorNombreProducto2 = nombreProductoContainer.querySelector('#error-nombre-producto-2')
              datalist.innerHTML = ''
              for (var i = 0; i < catalogoMaterial.length; i++) {
                if (catalogoMaterial[i].value.toUpperCase().startsWith(input.value.toUpperCase())) {
                  const option = document.createElement('option')
                  option.value = catalogoMaterial[i].value
                  option.innerText = catalogoMaterial[i].text
                  datalist.appendChild(option)
                }
                if (datalist.childElementCount == 0) {
                  errorNombreProducto2.style.display = 'none'
                  enableAllFields(input)
                } else {
                  errorNombreProducto2.style.display = 'block'
                  disableAllFields(input)
                }
              }
            })

            const validateNombreProductoOnChange = () => {
              const nombreProductoContainer = input.closest('.nombre-producto-container')
              const errorNombreProducto2 = nombreProductoContainer.querySelector('#error-nombre-producto-2')
              let showError = false
              for (var i = 0; i < catalogoMaterial.length; i++) {
                if (catalogoMaterial[i].value.toUpperCase() == input.value.toUpperCase()) {
                  showError = true
                  break
                }
              }
              if (showError) {
                errorNombreProducto2.style.display = 'block'
                disableAllFields(input)
              } else {
                errorNombreProducto2.style.display = 'none'
                enableAllFields(input)
              }
            }
            input.addEventListener('change', validateNombreProductoOnChange)
        })

        // Validación foto producto
        var fotoProductoInputs = document.querySelectorAll('.material-foto-producto')
        fotoProductoInputs.forEach(input => {
            const validateFotoProducto = () => {
                const fotoProductoContainer = input.closest('.foto-producto-container')
                const imagePreview = fotoProductoContainer.querySelector('#id_foto_producto_img')
                const imageDownload = fotoProductoContainer.querySelector('#id_foto_producto_download')
                if (input.files && input.files[0]) {
                    var reader = new FileReader()
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result
                        imageDownload.href = e.target.result
                    };
                    reader.readAsDataURL(input.files[0]);
                    imagePreview.style.display = 'block'
                    imageDownload.style.display = 'block'
                }
                else {
                    imagePreview.src = ''
                    imagePreview.style.display = 'none'
                    imageDownload.src = ''
                    imageDownload.style.display = 'none'
                }
            }
            input.addEventListener('change', validateFotoProducto)
        })

        // Validación ficha técnica
        var fichaTecnicaInputs = document.querySelectorAll('.material-ficha-tecnica')
        fichaTecnicaInputs.forEach(input => {
            const validateFichaTecnica = () => {
                const fichaTecnicaContainer = input.closest('.ficha-tecnica-container')
                const imagePreview = fichaTecnicaContainer.querySelector('#id_ficha_tecnica_img')
                const imageDownload = fichaTecnicaContainer.querySelector('#id_ficha_tecnica_download')
                if (input.files && input.files[0]) {
                    var reader = new FileReader()
                    reader.onload = function(e) {
                        if (input.files[0].type.startsWith('image/')) {
                            imagePreview.src = e.target.result
                            imageDownload.href = e.target.result
                        }
                        else {
                            imagePreview.src = '../../../static/images/pdf-default.png'
                            imageDownload.href = e.target.result
                        }
                    }
                    reader.readAsDataURL(input.files[0])
                    imagePreview.style.display = 'block'
                    imageDownload.style.display = 'block'
                }
                else {
                    imagePreview.src = ''
                    imagePreview.style.display = 'none'
                    imageDownload.src = ''
                    imageDownload.style.display = 'none'
                }
            }
            input.addEventListener('change', validateFichaTecnica)
        })

        // Validación largo
        var largoInputs = document.querySelectorAll('.material-largo')
        largoInputs.forEach(input => {
            const validateLargo = () => {
                var largoValue = input.value
                var container = input.closest('.largo-container')
                var errorLargo = container.querySelector('#error-largo')
                // Verificar si el valor es "N/A", numérico o fracción
                if (largoValue === 'N/A' || 
                  !isNaN(parseFloat(largoValue)) && isFinite(largoValue) || 
                  fraccionPattern.test(largoValue)) {
                    errorLargo.style.display = 'none'
                    enableAllFields(input)
                    if (largoValue === 'N/A') {
                      const medidasContainer = input.closest('#medidas-container')
                      const medidaLargo = medidasContainer.querySelector('#select-largo')
                      const labelLargo = medidasContainer.querySelector('#label-largo')
                      medidaLargo.value = ''
                      labelLargo.style.display = 'block'
                      labelLargo.innerHTML = 'No aplica'
                    }
                } else {
                    errorLargo.style.display = 'block'
                    disableAllFields(input)
                }
            }
            input.addEventListener('input', validateLargo)

            input.addEventListener('focus', () => {
              validateLargo()
              var medidasContainer = input.closest('#medidas-container')
              var selectLargo = medidasContainer.querySelector('#select-largo')
              var selectAncho = medidasContainer.querySelector('#select-ancho')
              var selectAlto = medidasContainer.querySelector('#select-alto')
              var selectCalibre = medidasContainer.querySelector('#select-calibre')
              selectLargo.style.display = 'block'
              selectAncho.style.display = 'none'
              selectAlto.style.display = 'none'
              selectCalibre.style.display = 'none'
              
              var largoValue = input.value
              var container = input.closest('.largo-container')
              var errorLargo = container.querySelector('#error-largo')
              // Verificar si el valor es "N/A", numérico o fracción
              if (largoValue === 'N/A' || 
                !isNaN(parseFloat(largoValue)) && isFinite(largoValue) || 
                fraccionPattern.test(largoValue)) {
                  errorLargo.style.display = 'none'
                  enableAllFields(input)
              } else {
                  errorLargo.style.display = 'block'
                  disableAllFields(input)
              }
            })
        })

        // Validación ancho
        var anchoInputs = document.querySelectorAll('.material-ancho')
        anchoInputs.forEach(input => {
            const validateAncho = () => {
                var anchoValue = input.value
                var container = input.closest('.ancho-container')
                var errorAncho = container.querySelector('#error-ancho')
                // Verificar si el valor es "N/A", numérico o fracción
                if (anchoValue === 'N/A' || 
                  !isNaN(parseFloat(anchoValue)) && isFinite(anchoValue) || 
                  fraccionPattern.test(anchoValue)) {
                    errorAncho.style.display = 'none'
                    enableAllFields(input)
                    const medidasContainer = input.closest('#medidas-container')
                    const medidaAncho = medidasContainer.querySelector('.select-um-ancho')
                    const labelAncho = medidasContainer.querySelector('#label-ancho')
                    labelAncho.style.display = 'block'
                    if (anchoValue === 'N/A') {
                      medidaAncho.value = ''
                      labelAncho.innerHTML = 'No aplica'
                    }
                    else {
                      if (medidasIguales) {
                        const medidaLargo = medidasContainer.querySelector('.select-um-largo')
                        medidaAncho.value = medidaLargo.value
                        labelAncho.innerHTML = medidaAncho.value
                      }
                    }
                } else {
                    errorAncho.style.display = 'block'
                    disableAllFields(input)
                }
            }
            input.addEventListener('input', validateAncho)
            input.addEventListener('focus', () => {
              validateAncho()
              if (!medidasIguales) {
                var medidasContainer = input.closest('#medidas-container')
                var selectLargo = medidasContainer.querySelector('#select-largo')
                var selectAncho = medidasContainer.querySelector('#select-ancho')
                var selectAlto = medidasContainer.querySelector('#select-alto')
                var selectCalibre = medidasContainer.querySelector('#select-calibre')
                selectLargo.style.display = 'none'
                selectAncho.style.display = 'block'
                selectAlto.style.display = 'none'
                selectCalibre.style.display = 'none'
                
                var anchoValue = input.value
                var container = input.closest('.ancho-container')
                var errorAncho = container.querySelector('#error-ancho')
                // Verificar si el valor es "N/A", numérico o fracción
                if (anchoValue === 'N/A' || 
                  !isNaN(parseFloat(anchoValue)) && isFinite(anchoValue) || 
                  fraccionPattern.test(anchoValue)) {
                    errorAncho.style.display = 'none'
                    enableAllFields(input)
                } else {
                    errorAncho.style.display = 'block'
                    disableAllFields(input)
                }
              }
            })
        })

        // Validación alto
        var altoInputs = document.querySelectorAll('.material-alto')
        altoInputs.forEach(input => {
            const validateAlto = () => {
                var altoValue = input.value
                var container = input.closest('.alto-container')
                var errorAlto = container.querySelector('#error-alto')
                // Verificar si el valor es "N/A", numérico o fracción
                if (altoValue === 'N/A' || 
                  !isNaN(parseFloat(altoValue)) && isFinite(altoValue) || 
                  fraccionPattern.test(altoValue)) {
                    errorAlto.style.display = 'none'
                    enableAllFields(input)
                    const medidasContainer = input.closest('#medidas-container')
                    const medidaAlto = medidasContainer.querySelector('.select-um-alto')
                    const labelAlto = medidasContainer.querySelector('#label-alto')
                    labelAlto.style.display = 'block'
                    if (altoValue === 'N/A') {
                      medidaAlto.value = ''
                      labelAlto.innerHTML = 'No aplica'
                    }
                    else {
                      if (medidasIguales) {
                        const medidaLargo = medidasContainer.querySelector('.select-um-largo')
                        medidaAlto.value = medidaLargo.value
                        labelAlto.innerHTML = medidaAlto.value
                      }
                    }
                } else {
                    errorAlto.style.display = 'block'
                    disableAllFields(input)
                }
            }
            input.addEventListener('input', validateAlto)
            input.addEventListener('focus', () => {
              validateAlto()
              if (!medidasIguales) {
                var medidasContainer = input.closest('#medidas-container')
                var selectLargo = medidasContainer.querySelector('#select-largo')
                var selectAncho = medidasContainer.querySelector('#select-ancho')
                var selectAlto = medidasContainer.querySelector('#select-alto')
                var selectCalibre = medidasContainer.querySelector('#select-calibre')
                selectLargo.style.display = 'none'
                selectAncho.style.display = 'none'
                selectAlto.style.display = 'block'
                selectCalibre.style.display = 'none'

                var altoValue = input.value
                var container = input.closest('.alto-container')
                var errorAlto = container.querySelector('#error-alto')
                // Verificar si el valor es "N/A", numérico o fracción
                if (altoValue === 'N/A' || 
                  !isNaN(parseFloat(altoValue)) && isFinite(altoValue) || 
                  fraccionPattern.test(altoValue)) {
                    errorAlto.style.display = 'none'
                    enableAllFields(input)
                } else {
                    errorAlto.style.display = 'block'
                    disableAllFields(input)
                }
              }
            })
        })

        // Validación calibre
        var calibreInputs = document.querySelectorAll('.material-calibre')
        calibreInputs.forEach(input => {
            const validateCalibre = () => {
                var calibreValue = input.value
                var container = input.closest('.calibre-container')
                var errorCalibre = container.querySelector('#error-calibre')
                // Verificar si el valor es "N/A", numérico o fracción
                if (calibreValue === 'N/A' || 
                  !isNaN(parseFloat(calibreValue)) && isFinite(calibreValue) || 
                  fraccionPattern.test(calibreValue)) {
                    errorCalibre.style.display = 'none'
                    enableAllFields(input)
                    const medidasContainer = input.closest('#medidas-container')
                    const medidaCalibre = medidasContainer.querySelector('.select-um-calibre')
                    const labelCalibre = medidasContainer.querySelector('#label-calibre')
                    labelCalibre.style.display = 'block'
                    if (calibreValue === 'N/A') {
                      medidaCalibre.value = ''
                      labelCalibre.innerHTML = 'No aplica'
                    }
                    else {
                      if (medidasIguales) {
                        const medidaLargo = medidasContainer.querySelector('.select-um-largo')
                        medidaCalibre.value = medidaLargo.value
                        labelCalibre.innerHTML = medidaCalibre.value
                      }
                    }
                } else {
                    errorCalibre.style.display = 'block'
                    disableAllFields(input)
                }
            }
            input.addEventListener('input', validateCalibre)
            input.addEventListener('focus', () => {
              validateCalibre()
              if (!medidasIguales) {
                var medidasContainer = input.closest('#medidas-container')
                var selectLargo = medidasContainer.querySelector('#select-largo')
                var selectAncho = medidasContainer.querySelector('#select-ancho')
                var selectAlto = medidasContainer.querySelector('#select-alto')
                var selectCalibre = medidasContainer.querySelector('#select-calibre')
                selectLargo.style.display = 'none'
                selectAncho.style.display = 'none'
                selectAlto.style.display = 'none'
                selectCalibre.style.display = 'block'

                var calibreValue = input.value
                var container = input.closest('.calibre-container')
                var errorCalibre = container.querySelector('#error-calibre')
                // Verificar si el valor es "N/A", numérico o fracción
                if (calibreValue === 'N/A' || 
                  !isNaN(parseFloat(calibreValue)) && isFinite(calibreValue) || 
                  fraccionPattern.test(calibreValue)) {
                    errorCalibre.style.display = 'none'
                    enableAllFields(input)
                } else {
                    errorCalibre.style.display = 'block'
                    disableAllFields(input)
                }
              }
            })
        })
        
        // Validación medidas iguales
        var mismaMedidaInputs = document.querySelectorAll('.medidas-iguales')
        mismaMedidaInputs.forEach(input => {
          input.addEventListener('change', () => {
            if (input.checked) {
              var unidadesMedidaContainer = input.closest('#id-unidades-medida')
              var largo = unidadesMedidaContainer.querySelector('.select-um-largo')
              var ancho = unidadesMedidaContainer.querySelector('.select-um-ancho')
              var alto = unidadesMedidaContainer.querySelector('.select-um-alto')
              var calibre = unidadesMedidaContainer.querySelector('.select-um-calibre')
              ancho.value = largo.value
              alto.value = largo.value
              calibre.value = largo.value
              unidadesMedidaContainer.querySelector('#select-largo').style.display = 'block'
              unidadesMedidaContainer.querySelector('#select-ancho').style.display = 'none'
              unidadesMedidaContainer.querySelector('#select-alto').style.display = 'none'
              unidadesMedidaContainer.querySelector('#select-calibre').style.display = 'none'
              medidasIguales = true
            }
            else {
              medidasIguales = false
            }
          })
        })

        // Validación unidad de medida para largo
        var umLargoInputs = document.querySelectorAll('.select-um-largo')
        umLargoInputs.forEach(input => {
          input.addEventListener('change', () => {
            const medidasContainer = input.closest('#medidas-container')
            const largo = medidasContainer.querySelector('.material-largo')
            const labelLargo = medidasContainer.querySelector('#label-largo')
            labelLargo.style.display = 'block'
            if (largo.value === 'N/A') {
              labelLargo.innerText = 'No aplica'
            } else {
              labelLargo.innerText = input.value
            }
            if (medidasIguales) {
              const ancho = medidasContainer.querySelector('.material-ancho')
              const alto = medidasContainer.querySelector('.material-alto')
              const calibre = medidasContainer.querySelector('.material-calibre')
              const umAncho = medidasContainer.querySelector('.select-um-ancho')
              const umAlto = medidasContainer.querySelector('.select-um-alto')
              const umCalibre = medidasContainer.querySelector('.select-um-calibre')
              umAncho.value = input.value
              umAlto.value = input.value
              umCalibre.value = input.value
              
              const labelAncho = medidasContainer.querySelector('#label-ancho')
              labelAncho.style.display = 'block'
              if (ancho.value === 'N/A') {
                labelAncho.innerText = 'No aplica'
              } else {
                labelAncho.innerText = umAncho.value
              }
              
              const labelAlto = medidasContainer.querySelector('#label-alto')
              labelAlto.style.display = 'block'
              if (alto.value === 'N/A') {
                labelAlto.innerText = 'No aplica'
              } else {
                labelAlto.innerText = umAlto.value
              }
              
              const labelCalibre = medidasContainer.querySelector('#label-calibre')
              labelCalibre.style.display = 'block'
              if (calibre.value === 'N/A') {
                labelCalibre.innerText = 'No aplica'
              } else {
                labelCalibre.innerText = umCalibre.value
              }
            }
          })
        })

        // Validación unidad de medida para ancho
        var umAnchoInputs = document.querySelectorAll('.select-um-ancho')
        umAnchoInputs.forEach(input => {
          input.addEventListener('change', () => {
            const medidasContainer = input.closest('#medidas-container')
            const ancho = medidasContainer.querySelector('.material-ancho')
            const labelAncho = medidasContainer.querySelector('#label-ancho')
            labelAncho.style.display = 'block'
            if (ancho.value === 'N/A') {
              labelAncho.innerText = 'No aplica'
            } else {
              labelAncho.innerText = input.value
            }
          })
        })

        // Validación unidad de medida para alto
        var umAltoInputs = document.querySelectorAll('.select-um-alto')
        umAltoInputs.forEach(input => {
          input.addEventListener('change', () => {
            const medidasContainer = input.closest('#medidas-container')
            const alto = medidasContainer.querySelector('.material-alto')
            const labelAlto = medidasContainer.querySelector('#label-alto')
            labelAlto.style.display = 'block'
            if (alto.value === 'N/A') {
              labelAlto.innerText = 'No aplica'
            } else {
              labelAlto.innerText = input.value
            }
          })
        })

        // Validación unidad de medida para calibre
        var umCalibreInputs = document.querySelectorAll('.select-um-calibre')
        umCalibreInputs.forEach(input => {
          input.addEventListener('change', () => {
            const medidasContainer = input.closest('#medidas-container')
            const calibre = medidasContainer.querySelector('.material-calibre')
            const labelCalibre = medidasContainer.querySelector('#label-calibre')
            labelCalibre.style.display = 'block'
            if (calibre.value === 'N/A') {
              labelCalibre.innerText = 'No aplica'
            } else {
              labelCalibre.innerText = input.value
            }
          })
        })

        // Validación material
        var materialInputs = document.querySelectorAll('.material-material')
        materialInputs.forEach(input => {
            const validateMaterial = () => {
                var materialValue = input.value
                var container = input.closest('.material-container')
                var errorMaterial = container.querySelector('#error-material')
                if (materialValue == '') {
                    errorMaterial.style.display = 'block'
                    disableAllFields(input)
                } else {
                    errorMaterial.style.display = 'none'
                    enableAllFields(input)
                }
            }
            input.addEventListener('focus', validateMaterial)
            input.addEventListener('input', validateMaterial)
        })

        // Validación color
        var colorInputs = document.querySelectorAll('.material-color')
        colorInputs.forEach(input => {
            const validateColor = () => {
                var colorValue = input.value
                var container = input.closest('.color-container')
                var errorColor = container.querySelector('#error-color')
                if (colorValue == '') {
                    errorColor.style.display = 'block'
                    disableAllFields(input)
                } else {
                    errorColor.style.display = 'none'
                    enableAllFields(input)
                }
            }
            input.addEventListener('focus', validateColor)
            input.addEventListener('input', validateColor)
        })

        // Validación unidad de medida
        var unidadMedidaInputs = document.querySelectorAll('.material-unidad-medida')
        unidadMedidaInputs.forEach(input => {
            const validateUnidadMedida = () => {
                var unidadMedidaValue = input.value
                var container = input.closest('.unidad-medida-container')
                var errorUnidadMedida = container.querySelector('#error-unidad-medida')
                // Verificar si el campo está vacío
                if (unidadMedidaValue == '') {
                  errorUnidadMedida.style.display = 'block'
                } else {
                  errorUnidadMedida.style.display = 'none'
                }
            }
            input.addEventListener('focus', validateUnidadMedida)
            input.addEventListener('change', validateUnidadMedida)
        })

        const disableAllFields = input => {
          const form = input.closest('.material-form')
          const tipoAlta = form.querySelector('.material-tipo-alta')
          const subfamilia = form.querySelector('.material-subfamilia')
          const nombre = form.querySelector('.material-nombre')
          const fotoProductoInput = form.querySelector('.material-foto-producto')
          const fotoProductoImg = form.querySelector('#id_foto_producto_img')
          const fotoProductoDownload = form.querySelector('#id_foto_producto_download')
          const fichaTecnicaInput = form.querySelector('.material-ficha-tecnica')
          const fichaTecnicaImg = form.querySelector('#id_ficha_tecnica_img')
          const fichaTecnicaDownload = form.querySelector('#id_ficha_tecnica_download')
          const largo = form.querySelector('.material-largo')
          const ancho = form.querySelector('.material-ancho')
          const alto = form.querySelector('.material-alto')
          const calibre = form.querySelector('.material-calibre')
          const medidasIguales = form.querySelector('.medidas-iguales')
          const umLargo = form.querySelector('.material-um-largo')
          const umAncho = form.querySelector('.material-um-ancho')
          const umAlto = form.querySelector('.material-um-alto')
          const umCalibre = form.querySelector('.material-um-calibre')
          const material = form.querySelector('.material-material')
          const color = form.querySelector('.material-color')
          const marca = form.querySelector('.material-marca')
          const parteModelo = form.querySelector('.material-parte-modelo')
          const nombreComun = form.querySelector('.material-nombre-comun')
          const ingActivo = form.querySelector('.material-ing-activo')
          const porcentajeIva = form.querySelector('.material-porcentaje-iva')
          const alias = form.querySelector('.material-alias')
          const unidadMedida = form.querySelector('.material-unidad-medida')
          const codigoSat = form.querySelector('.material-codigo-sat')
          const esMezcla = form.querySelector('.material-es-mezcla')
          const esMaterialEmpaque = form.querySelector('.material-es-material-empaque')
          const esProdTerminado = form.querySelector('.material-es-prod-terminado')
          const saveChanges = form.querySelector('.btn-save-changes')

          tipoAlta.setAttribute('disabled', true)
          subfamilia.setAttribute('disabled', true)
          if (!input.classList.contains('material-nombre')) {
            nombre.setAttribute('disabled', true)
          }
          fotoProductoInput.setAttribute('disabled', true)
          fotoProductoImg.style.opacity = 0.5
          if (fotoProductoDownload) {
            fotoProductoDownload.style.display = 'none'
          }
          fichaTecnicaInput.setAttribute('disabled', true)
          fichaTecnicaImg.style.opacity = 0.5
          if (fichaTecnicaDownload) {
            fichaTecnicaDownload.style.display = 'none'
          }
          if (!input.classList.contains('material-largo')) {
            largo.setAttribute('disabled', true)
          }
          if (!input.classList.contains('material-ancho')) {
            ancho.setAttribute('disabled', true)
          }
          if (!input.classList.contains('material-alto')) {
            alto.setAttribute('disabled', true)
          }
          if (!input.classList.contains('material-calibre')) {
            calibre.setAttribute('disabled', true)
          }
          medidasIguales.setAttribute('disabled', true)
          umLargo.setAttribute('disabled', true)
          umAncho.setAttribute('disabled', true)
          umAlto.setAttribute('disabled', true)
          umCalibre.setAttribute('disabled', true)
          if (!input.classList.contains('material-material')) {
            material.setAttribute('disabled', true)
          }
          if (!input.classList.contains('material-color')) {
            color.setAttribute('disabled', true)
          }
          marca.setAttribute('disabled', true)
          parteModelo.setAttribute('disabled', true)
          nombreComun.setAttribute('disabled', true)
          ingActivo.setAttribute('disabled', true)
          porcentajeIva.setAttribute('disabled', true)
          alias.setAttribute('disabled', true)
          unidadMedida.setAttribute('disabled', true)
          codigoSat.setAttribute('disabled', true)
          esMezcla.setAttribute('disabled', true)
          esMaterialEmpaque.setAttribute('disabled', true)
          esProdTerminado.setAttribute('disabled', true)
          saveChanges.setAttribute('disabled', true)
        }

        const enableAllFields = input => {
          const form = input.closest('.material-form')
          const tipoAlta = form.querySelector('.material-tipo-alta')
          const subfamilia = form.querySelector('.material-subfamilia')
          const nombre = form.querySelector('.material-nombre')
          const fotoProductoInput = form.querySelector('.material-foto-producto')
          const fotoProductoImg = form.querySelector('#id_foto_producto_img')
          const fotoProductoDownload = form.querySelector('#id_foto_producto_download')
          const fichaTecnicaInput = form.querySelector('.material-ficha-tecnica')
          const fichaTecnicaImg = form.querySelector('#id_ficha_tecnica_img')
          const fichaTecnicaDownload = form.querySelector('#id_ficha_tecnica_download')
          const largo = form.querySelector('.material-largo')
          const ancho = form.querySelector('.material-ancho')
          const alto = form.querySelector('.material-alto')
          const calibre = form.querySelector('.material-calibre')
          const medidasIguales = form.querySelector('.medidas-iguales')
          const umLargo = form.querySelector('.material-um-largo')
          const umAncho = form.querySelector('.material-um-ancho')
          const umAlto = form.querySelector('.material-um-alto')
          const umCalibre = form.querySelector('.material-um-calibre')
          const material = form.querySelector('.material-material')
          const color = form.querySelector('.material-color')
          const marca = form.querySelector('.material-marca')
          const parteModelo = form.querySelector('.material-parte-modelo')
          const nombreComun = form.querySelector('.material-nombre-comun')
          const ingActivo = form.querySelector('.material-ing-activo')
          const porcentajeIva = form.querySelector('.material-porcentaje-iva')
          const alias = form.querySelector('.material-alias')
          const unidadMedida = form.querySelector('.material-unidad-medida')
          const codigoSat = form.querySelector('.material-codigo-sat')
          const esMezcla = form.querySelector('.material-es-mezcla')
          const esMaterialEmpaque = form.querySelector('.material-es-material-empaque')
          const esProdTerminado = form.querySelector('.material-es-prod-terminado')
          const saveChanges = form.querySelector('.btn-save-changes')

          tipoAlta.removeAttribute('disabled')
          subfamilia.removeAttribute('disabled')
          nombre.removeAttribute('disabled')
          fotoProductoInput.removeAttribute('disabled')
          fotoProductoImg.style.opacity = 1
          if (fotoProductoDownload) {
            fotoProductoDownload.style.display = 'block'
          }
          fichaTecnicaInput.removeAttribute('disabled')
          fichaTecnicaImg.style.opacity = 1
          if (fichaTecnicaDownload) {
            fichaTecnicaDownload.style.display = 'block'
          }
          largo.removeAttribute('disabled')
          ancho.removeAttribute('disabled')
          alto.removeAttribute('disabled')
          calibre.removeAttribute('disabled')
          medidasIguales.removeAttribute('disabled')
          umLargo.removeAttribute('disabled')
          umAncho.removeAttribute('disabled')
          umAlto.removeAttribute('disabled')
          umCalibre.removeAttribute('disabled')
          material.removeAttribute('disabled')
          color.removeAttribute('disabled')
          marca.removeAttribute('disabled')
          parteModelo.removeAttribute('disabled')
          nombreComun.removeAttribute('disabled')
          ingActivo.removeAttribute('disabled')
          porcentajeIva.removeAttribute('disabled')
          alias.removeAttribute('disabled')
          unidadMedida.removeAttribute('disabled')
          codigoSat.removeAttribute('disabled')
          esMezcla.removeAttribute('disabled')
          esMaterialEmpaque.removeAttribute('disabled')
          esProdTerminado.removeAttribute('disabled')
          saveChanges.removeAttribute('disabled')
        }
      }

      validarCamposMaterial()

      const fillTable = () => {
        materialCounter = 0
        bodyMaterials.innerHTML = ''
        const materialForms = document.querySelectorAll('.material-form')
        materialForms.forEach((materialForm, index) => {
          materialCounter++
          const tipoAlta = materialForm.querySelector('.material-tipo-alta')
          const subfamilia = materialForm.querySelector('.material-subfamilia')
          const nombre = materialForm.querySelector('.material-nombre')
          const fotoProducto = materialForm.querySelector('#id_foto_producto_img')
          const largo = materialForm.querySelector('.material-largo')
          const ancho = materialForm.querySelector('.material-ancho')
          const alto = materialForm.querySelector('.material-alto')
          const calibre = materialForm.querySelector('.material-calibre')
          const umLargo = materialForm.querySelector('.material-um-largo')
          const umAncho = materialForm.querySelector('.material-um-ancho')
          const umAlto = materialForm.querySelector('.material-um-alto')
          const umCalibre = materialForm.querySelector('.material-um-calibre')
          const material = materialForm.querySelector('.material-material')
          const color = materialForm.querySelector('.material-color')
          const marca = materialForm.querySelector('.material-marca')
          const parteModelo = materialForm.querySelector('.material-parte-modelo')
          const nombreComun = materialForm.querySelector('.material-nombre-comun')
          const ingActivo = materialForm.querySelector('.material-ing-activo')
          const porcentajeIva = materialForm.querySelector('.material-porcentaje-iva')
          const alias = materialForm.querySelector('.material-alias')
          const unidadMedida = materialForm.querySelector('.material-unidad-medida')
          const codigoSat = materialForm.querySelector('.material-codigo-sat')
          const esMezcla = materialForm.querySelector('.material-es-mezcla')
          const esMaterialEmpaque = materialForm.querySelector('.material-es-material-empaque')
          const esProdTerminado = materialForm.querySelector('.material-es-prod-terminado')
  
          esMezclaValue = esMezcla.checked == true ? 'Si' : 'No'
          esMaterialEmpaqueValue = esMaterialEmpaque.checked == true ? 'Si' : 'No'
          esProdTerminadoValue = esProdTerminado.checked == true ? 'Si' : 'No'

          const rechazado = materialForm.querySelector('.material-rechazado')
  
          const newRow = bodyMaterials.insertRow()
          newRow.classList.add('table-row')

          if (rechazado.value == 'true') {
            newRow.classList.add('table-row-hidden')
            materialCounter--
          }

          newRow.id = `table-row-${index}`
          newRow.innerHTML = `
          <td>${tipoAlta.value}</td>
          <td>${subfamilia.value}</td>
          <td>${nombre.value}</td>
          <td class="p-0"><img class="w-100" src="${fotoProducto.src}" alt="Foto del producto"/></td>
          <td>${largo.value}<br />UM: ${umLargo.value}</td>
          <td>${ancho.value}<br />UM: ${umAncho.value}</td>
          <td>${alto.value}<br />UM: ${umAlto.value}</td>
          <td>${calibre.value}<br />UM: ${umCalibre.value}</td>
          <td>${material.value}</td>
          <td>${color.value}</td>
          <td>${marca.value}</td>
          <td>${parteModelo.value}</td>
          <td>${nombreComun.value}</td>
          <td>${ingActivo.value}</td>
          <td>${porcentajeIva.value}</td>
          <td>${alias.value}</td>
          <td>${unidadMedida.value}</td>
          <td>${codigoSat.value}</td>
          <td>${esMezclaValue}</td>
          <td>${esMaterialEmpaqueValue}</td>
          <td>${esProdTerminadoValue}</td>
          <td>
            <button id="edit-material-${index}" class="btn btn-primary edit-material" type="button" style="font-size:0.8rem">Editar</button>
          </td>
          <td>
            <button id="remove-material-${index}" class="btn btn-danger remove-material" type="button" style="font-size:0.8rem">Eliminar</button>
          </td>`
        })

        disableRemoveButtons()
      }

      if (tableMaterials) {
        fillTable()

        tableMaterials.addEventListener('click', function(event) {

          // Editar material
          if (event.target && event.target.classList.contains('edit-material')) {
            // Llenar la tabla con la información actualizada
            fillTable()
            // Deshabilitando los botones Editar
            const editButtons = tableMaterials.querySelectorAll('.edit-material');
            editButtons.forEach(editButton => {
              editButton.setAttribute('disabled', true)
            })
            event.target.disabled = true
            // Mostrar el formulario seleccionado
            const forms = document.getElementsByClassName('material-form');
            for (let i = 0; i < forms.length; i++) {
              forms[i].style.display = 'none'
            }
            editingId = event.target.id.substring(14, event.target.id.length)
            const form = document.getElementById(`material-form-${editingId}`)
            if (form) {
              form.style.display = "block"
              medidasIguales = false
            }

            // Deshabilitar botones de tipo submit. Se habilitarán al hacer clic en "Guardar cambios"
            if (btnSave) {
              btnSave.setAttribute('disabled', true)
              btnRemove.setAttribute('disabled', true)
            }
            if (btnApprove) {
              btnApprove.setAttribute('disabled', true)
              btnDecline.setAttribute('disabled', true)
            }
          }

          // Eliminar material
          if (event.target && event.target.classList.contains('remove-material')) {
            removeId = event.target.id.substring(16, event.target.id.length)
            const form = document.getElementById(`material-form-${removeId}`)
            if (form) {
              // En vez de eliminar el material, hacemos que su variable "Rechazado" sea true
              //form.remove()
              //form.rechazado = true
              const rechazado = form.querySelector('.material-rechazado')
              rechazado.value = true
              if (comentarios) {
                comentarios.setAttribute('required', 'true')
                materialEliminado = true
              }

              // Recorre todos los formularios restantes y actualiza sus índices
              /*const forms = materialFormsContainer.querySelectorAll('.material-form');
              var counter = 0
              forms.forEach(form => {
                form.id = `material-form-${counter}`
                const inputs = form.querySelectorAll('[id^=id_material-]');
                for (let j = 0; j < inputs.length; j++) {
                  inputs[j].id = inputs[j].id.replace(/\d+/, i);
                }
                form.style.display = 'none'
                counter++
              })*/

              // Las banderas de tipo "rechazado" serán true
              /*if (rechazado_compras) {
                rechazado_compras.value = true
              }
              if (rechazado_sistemas) {
                rechazado_sistemas.value = true
              }*/
            }

            fillTable()
          }
        })
      }

      const makeFieldsMandatory = () => {
        if (empresaOrigen) {
          empresaOrigen.setAttribute('required', true)
        }
        if (empresaDestino) {
          empresaDestino.setAttribute('required', true);
        }
        if (nombreProductoMigracion) {
          nombreProductoMigracion.setAttribute('required', true);
        }
        if (empresa) {
          empresa.setAttribute('required', true);
        }
        if (justificacion) {
          justificacion.setAttribute('required', true);
        }
      }

      makeFieldsMandatory()

      const makeFieldsOptional = () => {
        if (empresaOrigen) {
          empresaOrigen.removeAttribute('required')
        }
        if (empresaDestino) {
          empresaDestino.removeAttribute('required');
        }
        if (nombreProductoMigracion) {
          nombreProductoMigracion.removeAttribute('required');
        }
        if (empresa) {
          empresa.removeAttribute('required');
        }
        if (justificacion) {
          justificacion.removeAttribute('required');
        }
      }

      if (btnRemove) {
        btnRemove.addEventListener('click', () => {
          makeFieldsOptional()
        })
      }

      const disableAllFieldsForMigracion = () => {
        empresaOrigen.setAttribute('disabled', true)
        empresaDestino.setAttribute('disabled', true)
        comentarios.setAttribute('disabled', true)
      }

      const enableAllFieldsForMigracion = () => {
        empresaOrigen.removeAttribute('disabled')
        empresaDestino.removeAttribute('disabled')
        comentarios.removeAttribute('disabled')
      }

      function enableSaveButton() {
        if(errorEmpresaOrigen) {
          if(errorEmpresaOrigen.style.display == 'block' || errorEmpresaDestino.style.display == 'block' || errorEmpresasMigracion.style.display == 'block' || errorNombreProductoMigracion.style.display == 'block' || errorNombreProductoMigracion2.style.display == 'block') {
            if(btnSave) {
              btnSave.disabled = true
              btnRemove.disabled = true
            }
            else {
              if(btnApprove && btnDecline) {
                btnApprove.disabled = true
                btnDecline.disabled = true
              }
            }
          }
          else {
            if (btnSave) {
              btnSave.disabled = false
              btnRemove.disabled = false
            }
            else {
              if (btnApprove && btnDecline) {
                btnApprove.disabled = false
                btnDecline.disabled = false
              }
            }
          }
        }
        else {
          if (errorEmpresa.style.display == 'block' || errorJustificacion.style.display == 'block' || errorComentarios?.style.display == 'block') {
            if(btnSave) {
              btnSave.disabled = true
              btnRemove.disabled = true
            }
            else {
              if(btnApprove && btnDecline) {
                btnApprove.disabled = true
                btnDecline.disabled = true
              }
            }
          }
          else {
            if (btnSave) {
              btnSave.disabled = false
              btnRemove.disabled = false
            }
            else {
              if (btnApprove && btnDecline) {
                btnApprove.disabled = false
                btnDecline.disabled = false
              }
            }
          }
        }
      }
    });
  </script>
{% endblock %}
