{% extends 'base.html' %}

{% block content %}
  <main class="container py-5 mt-5">
    <div class="row d-flex justify-content-center">
      <div class="col-md-6 align-self-center mx-auto">
        <form class="card card-body" method="POST">
          <h1 class="mb-4">Detalle de la solicitud</h1>
          {{ error }}
          {% csrf_token %}

          {{ solicitud_form.as_p }}

          <h3>Materiales</h3>
          <div id="material-forms">
            {% for form in material_forms %}
              <div class="material-form">
                {{ form.as_p }}
                <hr />
              </div>
            {% endfor %}
          </div>

          <div id="buttons-container">
            {% if solicitud.pendiente == True and current_user.compras == False and current_user.finanzas == False and current_user.sistemas == False or solicitud.rechazado_compras == True or solicitud.rechazado_finanzas == True or solicitud.rechazado_sistemas == True %}
              <button class="btn btn-primary" style="margin: 10px 0;" type="submit" name="pendiente" value="True">Guardar cambios</button>
            {% endif %}

            {% if current_user.compras == True %}
              <button class="btn btn-primary btn-approve" style="margin: 10px 0;" type="submit" name="compras" value="True">Aprobar compras</button>

              <button class="btn btn-primary btn-reject" style="margin: 10px 0;" type="submit" name="rechazado_compras" value="True">Rechazar compras</button>
            {% endif %}

            {% if current_user.finanzas == True %}
              <button class="btn btn-primary btn-approve" style="margin: 10px 0;" type="submit" name="finanzas" value="True">Aprobar finanzas</button>

              <button class="btn btn-primary btn-reject" style="margin: 10px 0;" type="submit" name="rechazado_finanzas" value="True">Rechazar finanzas</button>
            {% endif %}

            {% if current_user.sistemas == True %}
              <button class="btn btn-primary btn-approve" style="margin: 10px 0;" type="submit" name="sistemas" value="True">Aprobar sistemas</button>

              <button class="btn btn-primary btn-reject" style="margin: 10px 0;" type="submit" name="rechazado_sistemas" value="True">Rechazar sistemas</button>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const materialFormsContainer = document.getElementById('material-forms');
  
      // Loading dinamically the data on the selects depending on the other selects
      materialFormsContainer.addEventListener('click', function(event) {
        var tipo_alta = document.querySelector("#id_material-0-tipo_alta")
        var tipo = document.querySelector("#id_material-0-tipo")
        var familia = document.querySelector("#id_material-0-familia")
        var subfamilia = document.querySelector("#id_material-0-subfamilia")
        var unidad_medida = document.querySelector("#id_material-0-unidad_medida")
  
        const setSelects = (id) => {
          tipo_alta = document.querySelector(`#id_material-${id}-tipo_alta`)
          tipo = document.querySelector(`#id_material-${id}-tipo`)
          familia = document.querySelector(`#id_material-${id}-familia`)
          subfamilia = document.querySelector(`#id_material-${id}-subfamilia`)
          unidad_medida = document.querySelector(`#id_material-${id}-unidad_medida`)
        }
  
        if (event.target && event.target.classList.contains('select-tipo-alta')) {
          setSelects(event.target.id.substring(12, event.target.id.length - 10))
        }
        if (event.target && event.target.classList.contains('select-tipo')) {
          setSelects(event.target.id.substring(12, event.target.id.length - 5))
        }
        if (event.target && event.target.classList.contains('select-familia')) {
          setSelects(event.target.id.substring(12, event.target.id.length - 8))
        }
        if (event.target && event.target.classList.contains('select-subfamilia')) {
          setSelects(event.target.id.substring(12, event.target.id.length - 11))
        }
        if (event.target && event.target.classList.contains('select-unidad-medida')) {
          setSelects(event.target.id.substring(12, event.target.id.length - 14))
        }
  
        const actualizarOpcionesTipo = () => {
          var opcionSeleccionada = tipo_alta.value
          var opciones = {{ tipo_list|safe }}
          tipo.options.length = 0
          opciones[opcionSeleccionada].forEach((opcion) => {
              var option = document.createElement("option")
              option.value = opcion.value
              option.text = opcion.display
              tipo.appendChild(option)
          })
        }
  
        const actualizarOpcionesUnidadMedida = () => {
            var opcionSeleccionada = tipo_alta.value
            var opciones = {{ unidad_medida_list|safe }}
            unidad_medida.options.length = 0
            opciones[opcionSeleccionada].forEach((opcion) => {
                var option = document.createElement("option")
                option.value = opcion.value
                option.text = opcion.display
                unidad_medida.appendChild(option)
            })
        }
  
        const actualizarOpcionesFamilia = () => {
            var opcionSeleccionada = tipo.value
            var opciones = {{ familia_list|safe }}
            familia.options.length = 0
            opciones[opcionSeleccionada].forEach((opcion) => {
                var option = document.createElement("option")
                option.value = opcion.value
                option.text = opcion.display
                familia.appendChild(option)
            })
        }
  
        const actualizarOpcionesSubfamilia = () => {
            var opcionSeleccionada = familia.value
            var opciones = {{ subfamilia_list|safe }}
            subfamilia.options.length = 0
            opciones[opcionSeleccionada].forEach((opcion) => {
                var option = document.createElement("option")
                option.value = opcion.value
                option.text = opcion.display
                subfamilia.appendChild(option)
            })
        }
  
        tipo_alta.addEventListener("change", actualizarOpcionesTipo)
        tipo_alta.addEventListener("change", actualizarOpcionesUnidadMedida)
        tipo.addEventListener("change", actualizarOpcionesFamilia)
        familia.addEventListener("change", actualizarOpcionesSubfamilia)
      });

      const buttonsContainer = document.getElementById('buttons-container');
      const comentarios = document.getElementById('id_comentarios');
      
      buttonsContainer.addEventListener('click', function(event) {  
        if (event.target && event.target.classList.contains('btn-reject')) {
          comentarios.setAttribute('required', 'true')
        }
        if (event.target && event.target.classList.contains('btn-approve')) {
          comentarios.removeAttribute('required')
        }
      });
    });
  </script>
{% endblock %}
